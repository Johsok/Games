<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>æš—æ£‹å¤§å¸« 2026</title>
    <style>
        :root {
            --bg-grad: radial-gradient(circle, #3e2723 0%, #1a0f0d 100%);
            --board-bg: #deb887;
            --board-texture: repeating-linear-gradient(45deg, rgba(0,0,0,0.03) 0px, rgba(0,0,0,0.03) 2px, transparent 2px, transparent 4px);
            --line-color: #5d4037;
            --piece-bg: radial-gradient(circle at 35% 35%, #fff8dc, #deb887);
            --piece-border: #8b5a2b;
            --piece-shadow: 2px 4px 8px rgba(0,0,0,0.5), inset 0 0 10px rgba(0,0,0,0.1);
            --red-c: #b71c1c;
            --black-c: #212121;
            --border-style: 10px ridge #6d4c41;
            --text-engrave: 0 1px 1px rgba(255,255,255,0.8), 0 -1px 1px rgba(0,0,0,0.1);
            --back-bg: #8d6e63;
            --back-pattern: #5d4037;
            
            /* Highlights */
            --selected-glow: rgba(255, 111, 0, 1);
            --last-move-glow: rgba(0, 229, 255, 1);
            --target-glow: rgba(255, 23, 68, 1);
            --origin-blue: rgba(0, 140, 255, 0.8);
        }
        
        /* === ä¸»é¡Œé¢¨æ ¼å®šç¾© === */
        body.t-classic { --bg-grad: radial-gradient(circle, #3e2723 0%, #1a0f0d 100%); --board-bg: #deb887; --line-color: #5d4037; --piece-bg: radial-gradient(circle at 35% 35%, #fff8dc, #deb887); --piece-border: #8b5a2b; --red-c: #b71c1c; --black-c: #212121; --border-style: 10px ridge #6d4c41; --back-bg: #8d6e63; --back-pattern: #4e342e; }
        body.t-ink { --bg-grad: linear-gradient(to bottom, #cfd9df 0%, #e2ebf0 100%); --board-bg: #f5f5f5; --board-texture: none; --line-color: #424242; --piece-bg: radial-gradient(circle at 30% 30%, #ffffff, #eeeeee); --piece-border: #666; --piece-shadow: 2px 3px 5px rgba(0,0,0,0.2); --red-c: #b71c1c; --black-c: #111; --border-style: 8px double #424242; --text-engrave: none; --back-bg: #ddd; --back-pattern: #bbb; }
        body.t-dark { --bg-grad: linear-gradient(135deg, #232526, #414345); --board-bg: #333; --board-texture: none; --line-color: #777; --piece-bg: radial-gradient(circle at 30% 30%, #555, #222); --piece-border: #888; --red-c: #ff5252; --black-c: #000; --text-engrave: 0 0 5px rgba(255,255,255,0.3); --border-style: 8px solid #555; --back-bg: #444; --back-pattern: #222; }
        body.t-jade { --bg-grad: radial-gradient(circle, #004d40, #00251a); --board-bg: #80cbc4; --line-color: #004d40; --piece-bg: radial-gradient(circle at 30% 30%, #e0f2f1, #80cbc4); --piece-border: #00695c; --red-c: #d32f2f; --black-c: #004d40; --border-style: 10px inset #00695c; --back-bg: #2e7d32; --back-pattern: #1b5e20; }
        body.t-wood { --bg-grad: linear-gradient(135deg, #4e342e, #1b100d); --board-bg: #8d6e63; --line-color: #3e2723; --piece-bg: radial-gradient(circle at 30% 30%, #d7ccc8, #8d6e63); --piece-border: #3e2723; --red-c: #5d4037; --black-c: #212121; --border-style: 10px groove #4e342e; --back-bg: #5d4037; --back-pattern: #3e2723; }
        body.t-gold { --bg-grad: radial-gradient(circle, #2b2b2b, #000); --board-bg: #111; --line-color: #ffd700; --piece-bg: radial-gradient(circle at 30% 30%, #fffacd, #ffd700); --piece-border: #b8860b; --red-c: #c00; --black-c: #000; --border-style: 8px solid #ffd700; --text-engrave: 0 1px 2px rgba(0,0,0,0.5); --back-bg: #333; --back-pattern: #ffd700; }
        body.t-ocean { --bg-grad: linear-gradient(to bottom, #0d47a1, #000051); --board-bg: #1976d2; --line-color: #bbdefb; --piece-bg: radial-gradient(circle at 30% 30%, #e3f2fd, #90caf9); --piece-border: #0d47a1; --red-c: #ff1744; --black-c: #01579b; --border-style: 8px double #90caf9; --back-bg: #1565c0; --back-pattern: #0d47a1; }
        body.t-royal { --bg-grad: linear-gradient(135deg, #4a148c, #1a0033); --board-bg: #7b1fa2; --line-color: #e1bee7; --piece-bg: radial-gradient(circle at 30% 30%, #f3e5f5, #e1bee7); --piece-border: #4a0072; --red-c: #d50000; --black-c: #311b92; --border-style: 8px solid #4a0072; --back-bg: #6a1b9a; --back-pattern: #4a0072; }
        body.t-cyber { --bg-grad: linear-gradient(135deg, #0f0c29, #302b63, #24243e); --board-bg: #000; --line-color: #0ff; --piece-bg: radial-gradient(circle at 30% 30%, #222, #000); --piece-border: #0ff; --red-c: #ff00de; --black-c: #00e5ff; --border-style: 8px solid #ff00de; --text-engrave: 0 0 5px rgba(255,255,255,0.8); --back-bg: #111; --back-pattern: #333; --piece-shadow: 0 0 10px rgba(0,255,255,0.3); --selected-glow: #ffff00; }
        body.t-sakura { --bg-grad: linear-gradient(to top, #fad0c4 0%, #ffd1ff 100%); --board-bg: #fff0f5; --line-color: #ffb7b2; --piece-bg: radial-gradient(circle at 30% 30%, #fff, #ffebee); --piece-border: #ff80ab; --red-c: #e91e63; --black-c: #880e4f; --border-style: 10px double #ff80ab; --back-bg: #f8bbd0; --back-pattern: #f48fb1; --text-engrave: none; }
        body.t-vintage { --bg-grad: radial-gradient(circle, #5d4037, #3e2723); --board-bg: #d7ccc8; --line-color: #3e2723; --piece-bg: #efebe9; --piece-border: #5d4037; --red-c: #bf360c; --black-c: #3e2723; --border-style: 10px dashed #4e342e; --back-bg: #a1887f; --back-pattern: #8d6e63; --text-engrave: none; box-shadow: inset 0 0 100px rgba(0,0,0,0.5); }
        body.t-ice { --bg-grad: linear-gradient(to bottom, #e0f7fa, #80deea); --board-bg: #b2ebf2; --line-color: #0097a7; --piece-bg: radial-gradient(circle at 30% 30%, #fff, #e0f7fa); --piece-border: #00acc1; --red-c: #d84315; --black-c: #006064; --border-style: 10px ridge #ffffff; --back-bg: #4dd0e1; --back-pattern: #26c6da; --text-engrave: 0 0 2px #fff; }
        body.t-stone { --bg-grad: linear-gradient(135deg, #434343, #000000); --board-bg: #7f8c8d; --line-color: #2c3e50; --piece-bg: radial-gradient(circle at 30% 30%, #bdc3c7, #95a5a6); --piece-border: #34495e; --red-c: #c0392b; --black-c: #2c3e50; --border-style: 10px inset #34495e; --back-bg: #7f8c8d; --back-pattern: #555; --text-engrave: 1px 1px 0 rgba(255,255,255,0.5), -1px -1px 0 rgba(0,0,0,0.5); }
        body.t-minimal { --bg-grad: #f0f0f0; --board-bg: #fff; --line-color: #ccc; --piece-bg: #fff; --piece-border: #999; --red-c: #ff3b30; --black-c: #1d1d1f; --border-style: 4px solid #ddd; --back-bg: #eee; --back-pattern: #ddd; --text-engrave: none; --piece-shadow: 0 2px 5px rgba(0,0,0,0.1); }

        /* === 30ç¨® ç¾ä»£è³ªæ„Ÿæ£‹å­èƒŒåœ– (CSS Override) === */
        
        /* A. ç¾ä»£æ¥µç°¡ & æè³ª (Modern) */
        /* 1. ç£¨ç ‚é»‘ Matte Black */
        body[data-back="matte-black"] .piece.back { background: radial-gradient(150% 150% at 30% 30%, #333 0%, #000 100%); border: 3px solid #111; box-shadow: inset 0 0 10px rgba(255,255,255,0.1); }
        /* 2. æ¯›ç»ç’ƒ Frosted */
        body[data-back="frosted"] .piece.back { background: rgba(255,255,255,0.4); backdrop-filter: blur(8px); -webkit-backdrop-filter: blur(8px); border: 2px solid rgba(255,255,255,0.6); box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
        /* 3. ç¢³çº–ç¶­ Carbon */
        body[data-back="carbon"] .piece.back { background: radial-gradient(black 15%, transparent 16%) 0 0, radial-gradient(black 15%, transparent 16%) 8px 8px, radial-gradient(rgba(255,255,255,.1) 15%, transparent 20%) 0 1px, radial-gradient(rgba(255,255,255,.1) 15%, transparent 20%) 8px 9px; background-color: #282828; background-size: 16px 16px; border-color: #111; }
        /* 4. é«®çµ²éŠ€ Brushed Metal */
        body[data-back="brushed"] .piece.back { background: repeating-linear-gradient(90deg, #ccc 0, #ccc 1px, #bbb 1px, #bbb 2px, #ddd 2px, #ddd 4px); box-shadow: inset 0 0 20px rgba(0,0,0,0.2); border-color: #999; }
        /* 5. æ–°æ“¬æ…‹ Neumorphism */
        body[data-back="neumorphism"] .piece.back { background: #e0e5ec; border: none; box-shadow: 6px 6px 12px #a3b1c6, -6px -6px 12px #ffffff; }
        /* 6. çš®é©ç¸«ç·š Leather */
        body[data-back="leather"] .piece.back { background: #5d4037; border: 3px dashed #8d6e63; box-shadow: inset 0 0 10px rgba(0,0,0,0.5); background-image: radial-gradient(rgba(255,255,255,0.1) 1px, transparent 1px); background-size: 4px 4px; }

        /* B. ç§‘å¹»èˆ‡è³½åš (Sci-Fi) */
        /* 7. åæ‡‰å † Arc Reactor */
        body[data-back="reactor"] .piece.back { background: radial-gradient(circle, #0ff 0%, #00bcd4 20%, #000 30%, #000 50%, #006064 60%, #000 70%); border: 2px solid #0ff; box-shadow: 0 0 10px #0ff; }
        /* 8. æ•…éšœè—è¡“ Glitch */
        body[data-back="glitch"] .piece.back { background: #000; background-image: linear-gradient(90deg, rgba(255,0,0,0.5) 25%, transparent 25%), linear-gradient(90deg, transparent 75%, rgba(0,0,255,0.5) 75%); background-size: 4px 4px; border: 2px solid #0f0; }
        /* 9. å…¨æ¯ç¶²æ ¼ Hologram */
        body[data-back="hologram"] .piece.back { background: rgba(0, 30, 255, 0.2); border: 2px solid rgba(0,200,255,0.6); background-image: linear-gradient(rgba(0,255,255,0.2) 1px, transparent 1px), linear-gradient(90deg, rgba(0,255,255,0.2) 1px, transparent 1px); background-size: 10px 10px; box-shadow: inset 0 0 15px rgba(0,200,255,0.4); }
        /* 10. é§­å®¢ä»£ç¢¼ Matrix */
        body[data-back="matrix"] .piece.back { background: #000; color: #0f0; border: 2px solid #006400; background-image: repeating-linear-gradient(0deg, transparent, transparent 2px, #003300 2px, #003300 4px); }
        /* 11. éœ“è™¹é‚Šæ¡† Neon */
        body[data-back="neon"] .piece.back { background: #111; border: 3px solid #ff00ff; box-shadow: 0 0 10px #ff00ff, inset 0 0 10px #ff00ff; }
        
        /* C. å¥¢è¯èˆ‡å¯¶çŸ³ (Luxury) */
        /* 12. é»‘é‡‘å¤§ç†çŸ³ Black Marble */
        body[data-back="marble"] .piece.back { background: #000; background-image: linear-gradient(135deg, #000 0%, #222 50%, #000 100%), radial-gradient(circle at 20% 80%, rgba(212,175,55,0.6) 0%, transparent 10%); border-color: #d4af37; }
        /* 13. ç«ç‘°é‡‘ Rose Gold */
        body[data-back="rosegold"] .piece.back { background: linear-gradient(135deg, #eec0c6 0%, #e6a7b1 50%, #d88996 100%); border: 2px solid #fff; box-shadow: inset 0 0 10px rgba(255,255,255,0.5); }
        /* 14. é‘½çŸ³åˆ‡é¢ Diamond */
        body[data-back="diamond"] .piece.back { background: conic-gradient(from 45deg, #e0f7fa, #b2ebf2, #80deea, #e0f7fa); border: 2px solid #fff; opacity: 0.9; }
        /* 15. æ¶²æ…‹æ°´éŠ€ Liquid Chrome */
        body[data-back="chrome"] .piece.back { background: linear-gradient(135deg, #ccc, #fff, #999, #fff); background-size: 400% 400%; animation: glow-blue 10s ease infinite; border-color: #eee; }
        /* 16. é»‘æ›œçŸ³ Obsidian */
        body[data-back="obsidian"] .piece.back { background: radial-gradient(circle at 40% 40%, #555, #000 60%); border: 1px solid #333; box-shadow: inset 0 0 20px #000; }

        /* D. æ±æ–¹èˆ‡ç¦ªæ„ (Eastern) */
        /* 17. æ°´å¢¨æšˆæŸ“ Ink Wash */
        body[data-back="inkwash"] .piece.back { background: #eee; background-image: radial-gradient(circle at 50% 50%, #111 0%, rgba(0,0,0,0.6) 30%, transparent 60%); border-color: #333; }
        /* 18. é’èŠ±ç“· Porcelain */
        body[data-back="porcelain"] .piece.back { background: #fff; background-image: radial-gradient(circle at 50% 50%, transparent 40%, #1565c0 41%, #1565c0 45%, transparent 46%); border: 3px solid #1565c0; }
        /* 19. æœ±æ¼†é‡‘ç²‰ Lacquer */
        body[data-back="lacquer"] .piece.back { background: #8b0000; background-image: radial-gradient(#ffd700 1px, transparent 1px); background-size: 10px 10px; border-color: #550000; }
        /* 20. æ¯å±±æ°´ Zen Garden */
        body[data-back="zen"] .piece.back { background: #e0e0e0; background-image: repeating-radial-gradient(circle at center, #ddd 0, #ddd 2px, #ccc 3px, #ccc 5px); border-color: #bbb; }
        /* 21. é’æµ·æ³¢ Seigaiha */
        body[data-back="seigaiha"] .piece.back { background: #1a237e; background-image: radial-gradient(circle at 50% 100%, transparent 10px, #ffd700 11px, #ffd700 12px, transparent 13px); background-size: 20px 20px; border-color: #ffd700; }

        /* E. è‡ªç„¶èˆ‡å…ƒç´  (Nature) */
        /* 22. æ·±æµ·å…‰é» Bio-Lumi */
        body[data-back="biolumi"] .piece.back { background: #001f3f; background-image: radial-gradient(circle, #7fdbff 1px, transparent 2px); background-size: 15px 15px; box-shadow: 0 0 10px #001f3f; border-color: #0074d9; }
        /* 23. å²©æ¼¿è£‚è®Š Magma */
        body[data-back="magma"] .piece.back { background: #222; background-image: linear-gradient(45deg, transparent 40%, #f00 45%, #ff0 50%, #f00 55%, transparent 60%); border-color: #333; }
        /* 24. æ˜Ÿç©º Galaxy */
        body[data-back="galaxy"] .piece.back { background: radial-gradient(circle at 30% 70%, #4a148c, #000); background-image: radial-gradient(#fff 1px, transparent 1px), radial-gradient(#fff 0.5px, transparent 0.5px); background-size: 20px 20px, 10px 10px; border-color: #7b1fa2; }
        /* 25. æ¥µå…‰ Aurora */
        body[data-back="aurora"] .piece.back { background: linear-gradient(135deg, #004d40, #69f0ae, #7c4dff); border-color: #00bfa5; opacity: 0.9; }
        /* 26. æ°´ç£¨çŸ³ Terrazzo */
        body[data-back="terrazzo"] .piece.back { background: #fff; background-image: radial-gradient(#f44336 2px, transparent 3px), radial-gradient(#2196f3 2px, transparent 3px), radial-gradient(#ffeb3b 2px, transparent 3px); background-size: 15px 15px, 20px 20px, 18px 18px; background-position: 0 0, 10px 10px, 5px 15px; border-color: #ddd; }

        /* F. æ½®æµèˆ‡è—è¡“ (Trend) */
        /* 27. è¿·å¹»æ¼¸å±¤ Acid */
        body[data-back="acid"] .piece.back { background: linear-gradient(45deg, #ff00cc, #3333ff); border: 2px solid #fff; }
        /* 28. æ­æ™®è—è¡“ Op Art */
        body[data-back="opart"] .piece.back { background: repeating-conic-gradient(#000 0deg 10deg, #fff 10deg 20deg); border-color: #000; }
        /* 29. å­Ÿè²æ–¯ Memphis */
        body[data-back="memphis"] .piece.back { background: #fffde7; background-image: linear-gradient(45deg, #ff4081 25%, transparent 25%), linear-gradient(-45deg, #00e5ff 25%, transparent 25%); background-size: 10px 10px; border: 3px solid #333; }
        /* 30. ç´™è—å±¤ç–Š Paper */
        body[data-back="paper"] .piece.back { background: #b3e5fc; box-shadow: inset 5px 5px 0 rgba(0,0,0,0.1), inset -5px -5px 0 rgba(255,255,255,0.4); border: 1px solid #81d4fa; }

        /* 31. é è¨­ */
        /* data-back="default" uses default styles defined in root themes */


        html, body { height: 100%; width: 100%; overflow: hidden; overscroll-behavior: none; }
        body { font-family: "Microsoft JhengHei", "PingFang TC", sans-serif; background: var(--bg-grad); margin: 0; display: flex; flex-direction: column; align-items: center; justify-content: flex-start; color: white; transition: background 0.5s; touch-action: none; box-sizing: border-box; }

        header { 
            width: 100%; height: auto; display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 4px; flex-shrink: 0; z-index: 100; 
            padding-top: calc(8px + env(safe-area-inset-top)); 
            padding-bottom: 8px;
            background: rgba(0,0,0,0.3); backdrop-filter: blur(8px); border-bottom: 1px solid rgba(255,255,255,0.1); box-shadow: 0 4px 10px rgba(0,0,0,0.2); 
        }
        .header-top { display: flex; align-items: center; justify-content: center; gap: 15px; width: 95%; max-width: 600px; }
        h2 { font-size: 1.1rem; margin: 0; letter-spacing: 1px; text-shadow: 0 2px 4px rgba(0,0,0,0.8); white-space: nowrap; font-weight: 700; }
        .status { color: #f1c40f; font-weight: bold; font-size: 0.9rem; text-shadow: 0 1px 3px rgba(0,0,0,0.9); line-height: 1.4; transition: all 0.3s; display: flex; gap: 10px; }
        
        #msg { 
            font-size: 0.85rem; color:#fff; margin-bottom:4px; 
            height: 24px; line-height: 24px; overflow: hidden; white-space: nowrap;
            display: flex; align-items: center; justify-content: center;
        }

        .btn-group { display: flex; gap: 8px; align-items: center; }
        .btn { background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); color: #f0f0f0; padding: 5px 12px; border-radius: 20px; cursor: pointer; font-size: 0.85rem; transition: all 0.2s; white-space: nowrap; backdrop-filter: blur(4px); box-shadow: 0 2px 5px rgba(0,0,0,0.2); }
        .btn:active { transform: scale(0.95); background: rgba(255,255,255,0.2); }
        .btn-red { background: rgba(220, 50, 50, 0.85); border: none; }
        .btn-undo { background: rgba(230, 140, 20, 0.85); border: none; }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }

        #settings { display: none; position: absolute; top: 70px; z-index: 2000; background: rgba(30, 30, 30, 0.95); color: #fff; width: 280px; padding: 20px; border-radius: 16px; box-shadow: 0 20px 60px rgba(0,0,0,0.9); backdrop-filter: blur(12px); border: 1px solid rgba(255,255,255,0.1); }
        
        /* Grid Layout for Settings */
        .set-grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 15px; }
        .set-item { width: 100%; }
        
        .set-item label { display: block; font-weight: bold; font-size: 0.8rem; margin-bottom: 6px; color: #aaa; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        select, input[type=range] { width: 100%; padding: 6px; border-radius: 8px; border: 1px solid #555; background: #222; color: #fff; box-sizing: border-box; font-size: 0.85rem; outline: none; }

        .toggle-btn { 
            width: 100%; height: 36px; 
            display: flex; align-items: center; justify-content: center; 
            background: #222; 
            border: 1px solid #555; 
            border-radius: 8px; cursor: pointer;
            font-size: 0.8rem;
            color: #fff; 
            font-weight: bold;
        }
        .toggle-btn:active { background: #333; }
        
        .checkbox-wrap { display: flex; align-items: center; justify-content: space-between; height: 36px; background: #222; border:1px solid #555; border-radius: 8px; padding: 0 10px; box-sizing: border-box;}
        .checkbox-wrap label { margin: 0; cursor: pointer; color: #fff; font-size: 0.8rem; font-weight: bold; }

        #rules-overlay { 
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            background: rgba(0,0,0,0.85); z-index: 3000; justify-content: center; align-items: center; 
            backdrop-filter: blur(5px);
        }
        .rules-box { 
            background: #2c2c2c; width: 85%; max-width: 500px; max-height: 85vh; 
            border-radius: 16px; border: 1px solid #555; padding: 25px; 
            overflow-y: auto; color: #eee; box-shadow: 0 10px 40px rgba(0,0,0,0.8);
            font-size: 0.95rem; line-height: 1.6;
        }
        .rules-box h3 { text-align: center; color: #f1c40f; margin-top: 0; margin-bottom: 15px; border-bottom: 1px solid #555; padding-bottom: 10px; }
        .rules-box h4 { color: #00e5ff; margin: 15px 0 8px 0; font-size: 1rem; }
        .rules-box ul { margin: 0; padding-left: 20px; }
        .rules-box li { margin-bottom: 4px; }
        .rules-box strong { color: #ff9; }

        #game-container { 
            flex-grow: 1; width: 100%; display: flex; justify-content: center; align-items: center; 
            overflow: hidden; position: relative; padding: 0; box-sizing: border-box; 
        }
        .board-wrap { 
            position: relative; background: var(--board-bg); background-image: var(--board-texture); 
            border: var(--border-style); border-radius: 6px; 
            box-shadow: 0 20px 50px rgba(0,0,0,0.7), inset 0 0 60px rgba(0,0,0,0.2); 
            padding: 0.5%; 
            box-sizing: border-box; 
            display: grid; grid-template-columns: repeat(4, 1fr); grid-template-rows: repeat(8, 1fr); gap: 2px;
            overflow: visible !important;
        }
        .cell { 
            position: relative; 
            border: 1px solid rgba(0,0,0,0.1); 
            display: flex; justify-content: center; align-items: center; 
            width: 100%; height: 100%; 
            min-width: 0; min-height: 0;
            overflow: visible !important; 
            z-index: auto; 
        }
        
        .piece { 
            position: relative; 
            width: 95%; 
            height: 95%;
            aspect-ratio: 1 / 1; 
            border-radius: 50% !important; 
            
            background: var(--piece-bg); border: 3px solid var(--piece-border); box-shadow: var(--piece-shadow); 
            display: flex; justify-content: center; align-items: center; 
            
            font-family: "Microsoft JhengHei", "Heiti TC", "KaiTi", sans-serif; 
            font-weight: 900; 
            font-size: 0.65em; 

            cursor: pointer; 
            z-index: 50; 
            transition: transform 0.15s cubic-bezier(0.175, 0.885, 0.32, 1.275); user-select: none; -webkit-tap-highlight-color: transparent; text-shadow: var(--text-engrave); 
            box-sizing: border-box;
        }
        
        .piece.red { color: var(--red-c); border-color: var(--red-c); }
        .piece.black { color: var(--black-c); border-color: var(--black-c); }
        
        .piece.back { 
            background: var(--back-bg); 
            border-color: rgba(0,0,0,0.2); 
            color: transparent; 
            text-shadow: none; 
            background-image: repeating-radial-gradient(
                circle at center, 
                var(--back-pattern) 0, 
                var(--back-pattern) 3px, 
                var(--back-bg) 3.5px, 
                var(--back-bg) 6.5px
            );
        }
        .piece.back::before { content: ''; } 

        @keyframes glow-orange {
            0%, 100% { box-shadow: 0 0 2px 2.6px var(--selected-glow), 0 0 10px 4px var(--selected-glow); }
            50%      { box-shadow: 0 0 2px 2.6px var(--selected-glow), 0 0 20px 8px var(--selected-glow); }
        }
        .piece.selected { z-index: 100 !important; border-color: var(--selected-glow); animation: glow-orange 2s infinite ease-in-out; }
        
        @keyframes glow-blue {
            0%, 100% { box-shadow: 0 0 2px 3px var(--last-move-glow), 0 0 10px 4px var(--last-move-glow); }
            50%      { box-shadow: 0 0 2px 3px var(--last-move-glow), 0 0 20px 8px var(--last-move-glow); }
        }
        .piece.last-move { z-index: 90 !important; animation: glow-blue 2s infinite ease-in-out; }
        
        @keyframes glow-red-pulse {
            0%, 100% { transform: scale(1);    box-shadow: 0 0 2px 3px var(--target-glow), 0 0 10px 3px var(--target-glow); }
            50%      { transform: scale(1.15); box-shadow: 0 0 2px 3px var(--target-glow), 0 0 20px 8px var(--target-glow); }
        }
        .piece.can-eat { animation: glow-red-pulse 1.5s infinite ease-in-out; z-index: 95 !important; border-color: var(--target-glow) !important; opacity: 1 !important; }

        .piece.ghost { opacity: 0.6; pointer-events: none; filter: none; z-index: 5 !important; box-shadow: none !important; border: 3px dashed #111 !important; background: transparent; }
        .piece.ghost.red { color: rgba(183, 28, 28, 0.7); border-color: #111 !important; }
        .piece.ghost.black { color: rgba(33, 33, 33, 0.7); border-color: #111 !important; }
        .piece.last-move.selected { animation: glow-orange 2s infinite ease-in-out; z-index: 101 !important; }

        .origin-mark { width: 70%; height: 70%; border-radius: 50%; border: 4px solid var(--origin-blue); box-shadow: 0 0 10px var(--origin-blue), inset 0 0 10px var(--origin-blue); opacity: 0.6; pointer-events: none; position: absolute; top: 15%; left: 15%; z-index: 10; }
        .dragging-piece { position: fixed !important; pointer-events: none !important; z-index: 9999 !important; box-shadow: 0 10px 20px rgba(0,0,0,0.5) !important; transform: translate(-50%, -50%) scale(1.15); opacity: 0.95; }
        .animating-piece { position: fixed !important; z-index: 9999 !important; transition: top 0.6s ease-in-out, left 0.6s ease-in-out; pointer-events: none; box-shadow: 0 10px 20px rgba(0,0,0,0.5) !important; }

        #win-overlay { 
            position: absolute; top: 50%; left: 50%; transform: translate(-50%,-50%); 
            pointer-events: none; opacity: 0; z-index: 1000; 
            width: 80%; /* Width is 80% of board */
            display: flex; justify-content: center; align-items: center;
            font: 900 0.85em "Microsoft JhengHei", sans-serif;
            color: #fff; -webkit-text-stroke: 1px #fff; text-shadow: 0 0 10px #0ff, 0 0 20px #0ff, 0 0 40px #0ff;
            /* Horizontal settings */
            writing-mode: horizontal-tb;
            text-orientation: mixed;
            letter-spacing: 0.1em;
            white-space: nowrap;
        }
        #win-overlay.show { opacity: 1; animation: win 2.5s ease-in-out infinite, hue 4s linear infinite; }
        
        @keyframes win { 
            0% { transform: translate(-50%,-50%) scale(0.5); opacity: 0; } 
            20%, 100% { transform: translate(-50%,-50%) rotate(-3deg); opacity: 1; } 
            60% { transform: translate(-50%,-52%) rotate(3deg); } 
        }
        @keyframes hue { to { filter: hue-rotate(360deg); } }
        
        @media screen and (orientation:landscape) and (max-width:1024px){
            body { position:absolute; top:50%; left:50%; width:100vh; height:100vw; transform:translate(-50%,-50%) rotate(-90deg); transform-origin:center; overflow:hidden }
            .piece { transform: rotate(90deg); } 
            .dragging-piece, .animating-piece { transform: translate(-50%, -50%) scale(1.15) rotate(90deg) !important; }
            .piece.selected { transform: rotate(90deg) scale(1.15) translateY(-4px) !important; }
            #win-overlay { 
                /* In landscape mobile (body rotated), rotate text to appear horizontal to viewer */
                transform: translate(-50%, -50%) rotate(90deg); 
                opacity: 0; 
            }
            #win-overlay.show { opacity: 1; animation: win-land 2.5s ease-in-out infinite, hue 4s linear infinite; }
            @keyframes win-land {
                0% { transform: translate(-50%,-50%) rotate(90deg) scale(0.5); opacity: 0; }
                20%, 100% { transform: translate(-50%,-50%) rotate(87deg); opacity: 1; } 
                60% { transform: translate(-50%,-52%) rotate(93deg); }
            }
            header { padding-top: calc(8px + max(env(safe-area-inset-left), env(safe-area-inset-right))) !important; }
        }
        .player-dot { width: 12px; height: 12px; border-radius: 50%; display: inline-block; border: 1px solid #fff; margin-right: 4px;}
        .dot-red { background: var(--red-c); }
        .dot-black { background: var(--black-c); }
        .dot-unk { background: #999; border-style: dashed;}
    </style>
</head>
<body class="t-classic" data-back="default">

<header id="main-header">
    <div class="header-top">
        <h2 id="txt-title">æš—æ£‹å¤§å¸« 2026</h2>
        <div class="status" id="status-bar"><span id="p1-status"><i class="player-dot dot-unk"></i>æˆ‘æ–¹</span><span id="p2-status"><i class="player-dot dot-unk"></i>å°æ‰‹</span></div>
    </div>
    <div id="msg">è«‹ç¿»ç‰Œæ±ºå®šé¡è‰²</div>
    <div class="btn-group">
        <button class="btn" id="btn-settings" onclick="toggleSet()">âš™ï¸ è¨­å®š</button>
        <button class="btn btn-undo" id="btn-undo" onclick="undo()">â†©ï¸ æ‚”æ£‹</button>
        <button class="btn btn-red" id="btn-restart" onclick="restart()">ğŸ”„ é‡é–‹</button>
    </div>
</header>

<div id="settings">
    <div class="set-grid-2">
        <div class="set-item">
            <label id="lbl-mode">å°æˆ°æ¨¡å¼</label>
            <select id="mode-sel" onchange="changeMode()">
                <option value="pve" id="opt-pve">ğŸ’» å–®äºº</option>
                <option value="pvp" id="opt-pvp">ğŸ‘¥ é›™äºº</option>
            </select>
        </div>
        <div class="set-item">
            <label id="lbl-theme">è¦–è¦ºé¢¨æ ¼</label>
            <select id="theme-sel" onchange="changeTheme()">
                <option value="t-classic" id="opt-t-classic">ğŸ’ ç¶“å…¸</option>
                <option value="t-ink" id="opt-t-ink">ğŸ”ï¸ æ°´å¢¨</option>
                <option value="t-dark" id="opt-t-dark">ğŸŒƒ æš—é»‘</option>
                <option value="t-jade" id="opt-t-jade">ğŸ“¿ ç¿¡ç¿ </option>
                <option value="t-wood" id="opt-t-wood">ğŸªµ ç´…æœ¨</option>
                <option value="t-gold" id="opt-t-gold">ğŸ‘‘ é»‘é‡‘</option>
                <option value="t-ocean" id="opt-t-ocean">ğŸŒŠ æ·±æµ·</option>
                <option value="t-royal" id="opt-t-royal">ğŸ›ï¸ ç´«ç¦</option>
                <option value="t-cyber" id="opt-t-cyber">ğŸ¤– è³½åš</option>
                <option value="t-sakura" id="opt-t-sakura">ğŸŒ¸ æ«»èŠ±</option>
                <option value="t-vintage" id="opt-t-vintage">ğŸ“œ å¾©å¤</option>
                <option value="t-ice" id="opt-t-ice">â„ï¸ å†°é›ª</option>
                <option value="t-stone" id="opt-t-stone">ğŸ—¿ å·¨çŸ³</option>
                <option value="t-minimal" id="opt-t-minimal">â¬œ æ¥µç°¡</option>
            </select>
        </div>
    </div>

    <div class="set-grid-2">
        <div class="set-item">
            <label id="lbl-diff">é›»è…¦é›£åº¦</label>
            <select id="diff-sel">
                <option value="easy" id="opt-easy">ç°¡å–® (èœé³¥)</option>
                <option value="medium" id="opt-medium">ä¸­ç­‰ (æ­£å¸¸)</option>
                <option value="hard" id="opt-hard">å›°é›£ (é«˜æ‰‹)</option>
                <option value="expert" id="opt-expert" selected>å°ˆå®¶ (è·æ¥­)</option>
                <option value="master" id="opt-master">å¤§å¸« (å®—å¸«)</option>
                <option value="god" id="opt-god">ç¥ (ä¸å¯æˆ°å‹)</option>
            </select>
        </div>
        <div class="set-item">
            <label id="lbl-back">æ£‹å­èƒŒåœ–</label>
            <select id="back-sel" onchange="changeBack()">
                <option value="default" id="opt-b-default" selected>âœ¨ é è¨­ (Default)</option>
                <optgroup label="A. ç¾ä»£è³ªæ„Ÿ (Modern)">
                    <option value="matte-black" id="opt-b-1">1. ç£¨ç ‚é»‘</option>
                    <option value="frosted" id="opt-b-2">2. æ¯›ç»ç’ƒ</option>
                    <option value="carbon" id="opt-b-3">3. ç¢³çº–ç¶­</option>
                    <option value="brushed" id="opt-b-4">4. é«®çµ²éŠ€</option>
                    <option value="neumorphism" id="opt-b-5">5. æ–°æ“¬æ…‹</option>
                    <option value="leather" id="opt-b-6">6. çš®é©ç¸«ç·š</option>
                </optgroup>
                <optgroup label="B. ç§‘å¹»è³½åš (Sci-Fi)">
                    <option value="reactor" id="opt-b-7">7. åæ‡‰å †</option>
                    <option value="glitch" id="opt-b-8">8. æ•…éšœè—è¡“</option>
                    <option value="hologram" id="opt-b-9">9. å…¨æ¯ç¶²æ ¼</option>
                    <option value="matrix" id="opt-b-10">10. é§­å®¢ä»£ç¢¼</option>
                    <option value="neon" id="opt-b-11">11. éœ“è™¹é‚Šæ¡†</option>
                </optgroup>
                <optgroup label="C. å¥¢è¯å¯¶çŸ³ (Luxury)">
                    <option value="marble" id="opt-b-12">12. é»‘é‡‘å¤§ç†çŸ³</option>
                    <option value="rosegold" id="opt-b-13">13. ç«ç‘°é‡‘</option>
                    <option value="diamond" id="opt-b-14">14. é‘½çŸ³åˆ‡é¢</option>
                    <option value="chrome" id="opt-b-15">15. æ¶²æ…‹æ°´éŠ€</option>
                    <option value="obsidian" id="opt-b-16">16. é»‘æ›œçŸ³</option>
                </optgroup>
                <optgroup label="D. æ±æ–¹ç¦ªæ„ (Eastern)">
                    <option value="inkwash" id="opt-b-17">17. æ°´å¢¨æšˆæŸ“</option>
                    <option value="porcelain" id="opt-b-18">18. é’èŠ±ç“·</option>
                    <option value="lacquer" id="opt-b-19">19. æœ±æ¼†é‡‘ç²‰</option>
                    <option value="zen" id="opt-b-20">20. æ¯å±±æ°´</option>
                    <option value="seigaiha" id="opt-b-21">21. é’æµ·æ³¢</option>
                </optgroup>
                <optgroup label="E. è‡ªç„¶å…ƒç´  (Nature)">
                    <option value="biolumi" id="opt-b-22">22. æ·±æµ·å…‰é»</option>
                    <option value="magma" id="opt-b-23">23. å²©æ¼¿è£‚è®Š</option>
                    <option value="galaxy" id="opt-b-24">24. æ˜Ÿç©ºæ˜Ÿé›²</option>
                    <option value="aurora" id="opt-b-25">25. æ¥µå…‰</option>
                    <option value="terrazzo" id="opt-b-26">26. æ°´ç£¨çŸ³</option>
                </optgroup>
                <optgroup label="F. æ½®æµè—è¡“ (Art)">
                    <option value="acid" id="opt-b-27">27. è¿·å¹»æ¼¸å±¤</option>
                    <option value="opart" id="opt-b-28">28. æ­æ™®è—è¡“</option>
                    <option value="memphis" id="opt-b-29">29. å­Ÿè²æ–¯</option>
                    <option value="paper" id="opt-b-30">30. ç´™è—å±¤ç–Š</option>
                </optgroup>
            </select>
        </div>
    </div>

    <div class="set-grid-2">
        <div class="set-item">
            <label id="lbl-music">èƒŒæ™¯éŸ³æ¨‚</label>
            <select id="music-sel" onchange="changeMusic()">
                <option value="none" id="opt-mute">ğŸ”‡ éœéŸ³</option>
                <option value="01" id="opt-m-01">ğŸµ æ¨‚æ›² 01</option>
                <option value="02" id="opt-m-02">ğŸµ æ¨‚æ›² 02</option>
                <option value="03" id="opt-m-03">ğŸµ æ¨‚æ›² 03</option>
                <option value="04" id="opt-m-04" selected>ğŸµ æ¨‚æ›² 04</option>
                <option value="05" id="opt-m-05">ğŸµ æ¨‚æ›² 05</option>
                <option value="06" id="opt-m-06">ğŸµ æ¨‚æ›² 06</option>
                <option value="07" id="opt-m-07">ğŸµ æ¨‚æ›² 07</option>
            </select>
        </div>
        <div class="set-item">
            <label id="lbl-lang">èªè¨€ (Lang)</label>
            <select id="lang-sel" onchange="changeLang()">
                <option value="zh-TW" selected>ç¹ä¸­</option>
                <option value="zh-CN">ç°¡ä¸­</option>
                <option value="en">è‹±æ–‡</option>
            </select>
        </div>
    </div>

    <div class="set-grid-2">
        <div class="set-item">
            <label id="lbl-vol-music">éŸ³æ¨‚ (20%)</label>
            <input type="range" id="vol-range" min="0" max="100" value="20" oninput="adjMusicVol()">
        </div>
        <div class="set-item">
            <label id="lbl-vol-sfx">éŸ³æ•ˆ (70%)</label>
            <input type="range" id="sfx-vol-range" min="0" max="100" value="70" oninput="adjSfxVol()">
        </div>
    </div>
    
    <div style="display: flex; gap: 8px; margin-bottom: 20px; align-items: center;">
        <div class="set-item checkbox-wrap" style="flex: 3;">
            <label for="ghost-check" id="lbl-ghost" style="font-size:0.75rem;">ğŸ‘» æç¤º</label>
            <input type="checkbox" id="ghost-check" checked onchange="toggleGhost()" style="width:16px; height:16px; accent-color:#f1c40f;">
        </div>
        <div class="set-item" style="flex: 3;">
            <button class="toggle-btn" id="btn-rules" onclick="toggleRules()" style="font-size:0.8rem; padding:0;">ğŸ“œ è¦å‰‡</button>
        </div>
        <div class="set-item" style="flex: 4;">
            <button class="toggle-btn" id="btn-home" onclick="goHome()" style="background:#c0392b; font-size:0.8rem; padding:0;">ğŸ  å›é¦–é </button>
        </div>
    </div>

    <button class="btn" style="width:100%; background:#444; padding: 10px; margin-top:5px;" onclick="toggleSet()" id="btn-done">å®Œæˆè¨­å®š</button>
</div>

<div id="rules-overlay" onclick="toggleRules()">
    <div class="rules-box" onclick="event.stopPropagation()" id="rules-content">
        </div>
</div>

<div id="game-container"><div class="board-wrap" id="board-wrap"><div id="win-overlay">You Win</div></div></div>
<audio id="bgm" loop></audio>

<script id="worker-script" type="javascript/worker">
    const SCORES = { 
        7: 1500, // å¸¥/å°‡
        6: 600,  // å£«/ä»•
        5: 500,  // ç›¸/è±¡
        4: 400,  // ä¿¥/è»Š
        3: 300,  // å‚Œ/é¦¬
        2: 1000, // ç‚®/åŒ…
        1: 200   // å…µ/å’
    };
    
    const PIECES_DEF = [
        { name: 'å¸¥', rank: 7, color: 'red', count: 1 }, { name: 'ä»•', rank: 6, color: 'red', count: 2 }, { name: 'ç›¸', rank: 5, color: 'red', count: 2 }, { name: 'ä¿¥', rank: 4, color: 'red', count: 2 }, { name: 'å‚Œ', rank: 3, color: 'red', count: 2 }, { name: 'ç‚®', rank: 2, color: 'red', count: 2 }, { name: 'å…µ', rank: 1, color: 'red', count: 5 },
        { name: 'å°‡', rank: 7, color: 'black', count: 1 }, { name: 'å£«', rank: 6, color: 'black', count: 2 }, { name: 'è±¡', rank: 5, color: 'black', count: 2 }, { name: 'è»Š', rank: 4, color: 'black', count: 2 }, { name: 'é¦¬', rank: 3, color: 'black', count: 2 }, { name: 'åŒ…', rank: 2, color: 'black', count: 2 }, { name: 'å’', rank: 1, color: 'black', count: 5 }
    ];

    self.onmessage = function(e) {
        const { board, aiColor, config, hiddenIndices } = e.data;
        const result = runAI(board, aiColor, config, hiddenIndices);
        self.postMessage(result);
    };

    function runAI(board, aiColor, config, hiddenIndices) {
        let bestM = null;
        let poolScore = 0;
        if (config.expect) poolScore = calcHiddenPool(board, aiColor);
        const start = Date.now();
        let depth = 1;
        
        try {
            while (depth <= config.depth) {
                let m = abRoot(board, depth, aiColor, start, config.time, config, poolScore, hiddenIndices.length);
                if (m) bestM = m; 
                if (m && m.score > 20000) break;
                if (Date.now() - start > config.time - 50) break;
                depth++;
            }
        } catch(err) {}

        if (config.errorRate > 0 && Math.random() < config.errorRate) {
            let rnds = genMoves(aiColor, board);
            if (hiddenIndices.length) rnds.push({ type: 'flip', from: hiddenIndices[0] });
            if (rnds.length) bestM = rnds[Math.floor(Math.random() * rnds.length)];
        }
        return bestM;
    }

    function calcHiddenPool(b, ac) {
        let val = 0;
        PIECES_DEF.forEach(d => {
            let seen = 0; b.forEach(p => { if(p && !p.hidden && p.name===d.name && p.color===d.color) seen++; });
            let rem = d.count - seen;
            if(rem > 0) val += (d.color===ac ? SCORES[d.rank] : -SCORES[d.rank]) * rem;
        });
        return val;
    }

    function abRoot(b, d, c, st, lim, cfg, ps, hCnt) {
        let ms = genMoves(c, b);
        let bestScore = -Infinity, bestMove = null;
        let killerFound = false;
        if(ms.length > 0) {
            if(ms[0].score > 50000) killerFound = true;
        }

        if (hCnt > 0 && !killerFound) {
            let cands = [];
            let strategicIdx = [9, 10, 21, 22, 5, 6, 25, 26]; 
            let preferred = strategicIdx.filter(idx => b[idx] && b[idx].hidden);
            
            if (preferred.length > 0 && hCnt > 20) { cands = preferred; } 
            else { for(let i=0; i<32; i++) if(b[i] && b[i].hidden) cands.push(i); }
            
            let tryCnt = Math.min(5, cands.length);
            for (let i = cands.length - 1; i > 0; i--) { const j = Math.floor(Math.random() * (i + 1)); [cands[i], cands[j]] = [cands[j], cands[i]]; }

            let baseFlip = cfg.expect ? (ps / hCnt) : 10;
            let currentEval = evalBd(c, b, true);
            if(currentEval < -500) baseFlip += 150;

            for(let k=0; k<tryCnt; k++) {
                let idx = cands[k];
                let score = baseFlip;
                let neighbors = getNeighbors(idx);
                neighbors.forEach(n => {
                    let np = b[n];
                    if(np && !np.hidden && np.color === c) {
                        if(np.rank === 7) { score -= 300; }
                        if(np.rank === 2) { score -= 100; }
                    }
                });

                ms.push({type:'flip', from:idx, score: score});
            }
        }

        ms.sort((x,y)=>y.score-x.score);

        let alpha = -Infinity;
        let beta = Infinity;

        for(let m of ms) {
            if(Date.now()-st > lim) throw "TO"; 
            let v;
            
            if(m.type==='flip') {
                v = evalBd(c, b, cfg.enhanced) + m.score; 
            } else {
                let cap = b[m.to];
                b[m.to]=b[m.from]; b[m.from]=null;
                v = -ab(d-1, -beta, -alpha, c==='red'?'black':'red', st, lim, b, cfg);
                b[m.from]=b[m.to]; b[m.to]=cap;
            }

            if(v > bestScore) {
                bestScore = v;
                bestMove = m;
            }
            alpha = Math.max(alpha, v);
        }
        return bestMove;
    }

    function ab(d, alf, bet, c, st, lim, b, cfg) {
        if(Date.now()-st > lim) throw "TO";
        if(d===0) return cfg.qs ? quiesce(alf, bet, c, b, cfg) : evalBd(c, b, cfg.enhanced);

        let ms = genMoves(c, b);
        if(ms.length===0) return -30000; 
        ms.sort((x,y)=>y.score-x.score);

        let bestVal = -Infinity;
        for(let m of ms) {
            let cap = b[m.to];
            b[m.to]=b[m.from]; b[m.from]=null;
            let v = -ab(d-1, -bet, -alf, c==='red'?'black':'red', st, lim, b, cfg);
            b[m.from]=b[m.to]; b[m.to]=cap;
            if(v > bestVal) bestVal = v;
            alf = Math.max(alf, v);
            if(alf >= bet) break;
        }
        return bestVal;
    }

    function quiesce(alf, bet, c, b, cfg) {
        let stand = evalBd(c, b, cfg.enhanced);
        if(stand >= bet) return bet;
        if(stand > alf) alf = stand;

        let ms = genMoves(c, b).filter(m => b[m.to]); 
        ms.sort((x,y)=>y.score-x.score);

        for(let m of ms) {
            let cap = b[m.to];
            b[m.to]=b[m.from]; b[m.from]=null;
            let v = -quiesce(-bet, -alf, c==='red'?'black':'red', b, cfg);
            b[m.from]=b[m.to]; b[m.to]=cap;
            if(v >= bet) return bet;
            if(v > alf) alf = v;
        }
        return alf;
    }

    function evalBd(c, b, enh) {
        let score = 0;
        let myP = [], opP = [];
        let myLive = 0, opLive = 0;

        for(let i=0; i<32; i++) {
            const p = b[i];
            if(p && !p.hidden) {
                if(p.color === c) { myP.push({p, i}); myLive++; } 
                else { opP.push({p, i}); opLive++; }
                let v = SCORES[p.rank];
                if(enh) {
                    if((i%4)>=1 && (i%4)<=2 && Math.floor(i/4)>=2 && Math.floor(i/4)<=5) v += 10;
                }
                score += (p.color === c ? v : -v);
            }
        }
        
        if(myLive === 0) return -30000;
        if(opLive === 0) return 30000;

        if(!enh) return score;

        myP.forEach(item => { if(item.p.rank === 2) score += scanCannonPotency(item.i, b, c); });
        opP.forEach(item => { if(item.p.rank === 2) score -= scanCannonPotency(item.i, b, item.p.color); });

        myP.forEach(item => { let moves = getMovesCnt(item.i, b, item.p); score += moves * 3; });
        opP.forEach(item => { let moves = getMovesCnt(item.i, b, item.p); score -= moves * 3; });

        let opHasKing = opP.some(x => x.p.rank === 7);
        let myHasKing = myP.some(x => x.p.rank === 7);
        
        if(myHasKing) {
            myP.filter(x => x.p.rank === 7).forEach(k => {
                getNeighbors(k.i).forEach(nIdx => {
                    let nP = b[nIdx];
                    if(nP && !nP.hidden && nP.color !== c && nP.rank === 1) score -= 800; 
                    if(nP && nP.hidden) score -= 50; 
                });
            });
        }
        if(opHasKing) {
            opP.filter(x => x.p.rank === 7).forEach(k => {
                getNeighbors(k.i).forEach(nIdx => {
                    let nP = b[nIdx];
                    if(nP && !nP.hidden && nP.color === c && nP.rank === 1) score += 800;
                });
            });
        }
        return score;
    }

    function scanCannonPotency(idx, b, color) {
        let val = 0;
        const directions = [[1,0],[-1,0],[0,1],[0,-1]];
        directions.forEach(([dx, dy]) => {
            let cx = (idx % 4) + dx, cy = Math.floor(idx / 4) + dy, count = 0, target = null;
            while(cx >= 0 && cx < 4 && cy >= 0 && cy < 8) {
                let ci = cy * 4 + cx;
                if (b[ci]) { 
                    count++; 
                    if (count === 2) { target = b[ci]; break; } 
                }
                cx += dx; cy += dy;
            }
            if (count === 1) val += 20; 
            if (count === 2 && target && !target.hidden && target.color !== color) {
                val += SCORES[target.rank] * 0.6;
            }
        });
        return val;
    }

    function getMovesCnt(i, b, p) {
        let cnt = 0;
        if(p.rank !== 2) getNeighbors(i).forEach(t => { if(isValidMove(i, t, b)) cnt++; });
        else cnt += 4; 
        return cnt;
    }

    function genMoves(c, b) {
        let ms = [];
        for(let i=0; i<32; i++) {
            const p = b[i];
            if(p && !p.hidden && p.color===c) {
                if(p.rank!==2) {
                    getNeighbors(i).forEach(t => {
                        if(isValidMove(i, t, b)) {
                            pushMoveWithScore(i, t, b, ms, p);
                        }
                    });
                } else {
                    [[1,0],[-1,0],[0,1],[0,-1]].forEach(([dx,dy]) => {
                        if(dx!==0) { 
                            let r = Math.floor(i/4)*4; 
                            for(let k=r; k<r+4; k++) if(k!==i && isValidMove(i, k, b)) pushMoveWithScore(i, k, b, ms, p); 
                        } else { 
                            let col = i%4; 
                            for(let k=col; k<32; k+=4) if(k!==i && isValidMove(i, k, b)) pushMoveWithScore(i, k, b, ms, p); 
                        }
                    });
                }
            }
        }
        return ms;
    }
    
    function pushMoveWithScore(f, t, b, arr, attacker) { 
        let s = 0; 
        const victim = b[t];
        if(victim) {
            s = SCORES[victim.rank] * 10 - SCORES[attacker.rank] + 10000;
            if(victim.rank === 7) s += 50000; 
            else if(victim.rank === 2) s += 20000;
            else if(victim.rank === 4) s += 5000;
        } else {
            s = 10;
            if(attacker.rank === 1) s += 20;
        }
        arr.push({type:'move', from:f, to:t, score:s}); 
    }

    function isValidMove(f, t, b) {
        const p1 = b[f], p2 = b[t], x1=f&3, y1=f>>2, x2=t&3, y2=t>>2, d=Math.abs(x1-x2)+Math.abs(y1-y2);
        if(p2 && !p2.hidden && p1.color===p2.color) return false;
        
        if(p1.rank===2) { 
            if(!p2) return d===1;
            
            if(p2.hidden) return false; 
            if(x1!==x2 && y1!==y2) return false;
            let c=0, s=Math.min(f,t)+(y1===y2?1:4), e=Math.max(f,t), st=y1===y2?1:4;
            for(let k=s; k<e; k+=st) if(b[k]) c++;
            return c===1; 
        } else {
            if(d!==1) return false; 
            if(!p2) return true; 
            if(p2.hidden) return false; 
            if(p1.rank===1 && p2.rank===7) return true; 
            if(p1.rank===7 && p2.rank===1) return false;
            return p1.rank >= p2.rank;
        }
    }

    function getNeighbors(i) { const x=i&3, y=i>>2; let n=[]; if(x>0)n.push(i-1); if(x<3)n.push(i+1); if(y>0)n.push(i-4); if(y<7)n.push(i+4); return n; }
</script>

<script>
// === Text & Language Data ===
const TRANSLATIONS = {
    "zh-TW": {
        title: "æš—æ£‹å¤§å¸« 2026",
        p1_name_pvp: "ç©å®¶1", p1_name_pve: "ç©å®¶", p2_name_pvp: "ç©å®¶2", p2_name_pve: "é›»è…¦",
        my_turn: "è¼ªåˆ°ä½ ", pc_thinking: "é›»è…¦æ€è€ƒä¸­...",
        flip_card_pvp1: "ç©å®¶1 ç¿»ç‰Œ", flip_card_pvp2: "ç©å®¶2 ç¿»ç‰Œ", flip_card_pve: "è«‹ç¿»ç‰Œ", flip_card_pc: "é›»è…¦ç¿»ç‰Œ",
        move_pvp1: "ç©å®¶1 èµ°æ£‹", move_pvp2: "ç©å®¶2 èµ°æ£‹",
        btn_settings: "âš™ï¸ è¨­å®š", btn_undo: "â†©ï¸ æ‚”æ£‹", btn_restart: "ğŸ”„ é‡é–‹",
        lbl_mode: "å°æˆ°æ¨¡å¼", opt_pve: "ğŸ’» å–®äºº (æŒ‘æˆ°é›»è…¦)", opt_pvp: "ğŸ‘¥ é›™äºº (åŒæ©Ÿå°å¥•)",
        lbl_theme: "è¦–è¦ºé¢¨æ ¼",
        opt_t_classic: "ğŸ’ ç¶“å…¸", opt_t_ink: "ğŸ”ï¸ æ°´å¢¨", opt_t_dark: "ğŸŒƒ æš—é»‘", opt_t_jade: "ğŸ“¿ ç¿¡ç¿ ",
        opt_t_wood: "ğŸªµ ç´…æœ¨", opt_t_gold: "ğŸ‘‘ é»‘é‡‘", opt_t_ocean: "ğŸŒŠ æ·±æµ·", opt_t_royal: "ğŸ›ï¸ ç´«ç¦",
        opt_t_cyber: "ğŸ¤– è³½åš", opt_t_sakura: "ğŸŒ¸ æ«»èŠ±", opt_t_vintage: "ğŸ“œ å¾©å¤",
        opt_t_ice: "â„ï¸ å†°é›ª", opt_t_stone: "ğŸ—¿ å·¨çŸ³", opt_t_minimal: "â¬œ æ¥µç°¡",
        lbl_diff: "é›»è…¦é›£åº¦ (AI ç­‰ç´š)", opt_easy: "ç°¡å–® (èœé³¥)", opt_medium: "ä¸­ç­‰ (æ­£å¸¸)", opt_hard: "å›°é›£ (é«˜æ‰‹)", opt_expert: "å°ˆå®¶ (è·æ¥­)", opt_master: "å¤§å¸« (å®—å¸«)", opt_god: "ç¥ (ä¸å¯æˆ°å‹)",
        lbl_music: "èƒŒæ™¯éŸ³æ¨‚", opt_mute: "ğŸ”‡ éœéŸ³",
        "opt_m_01": "ğŸµ æ¨‚æ›² 01", "opt_m_02": "ğŸµ æ¨‚æ›² 02", "opt_m_03": "ğŸµ æ¨‚æ›² 03", "opt_m_04": "ğŸµ æ¨‚æ›² 04", "opt_m_05": "ğŸµ æ¨‚æ›² 05", "opt_m_06": "ğŸµ æ¨‚æ›² 06", "opt_m_07": "ğŸµ æ¨‚æ›² 07",
        lbl_lang: "èªè¨€ (Language)",
        lbl_vol_music: "éŸ³æ¨‚éŸ³é‡", lbl_vol_sfx: "éŸ³æ•ˆéŸ³é‡",
        lbl_ghost: "ğŸ‘» æç¤º", btn_rules: "ğŸ“œ è¦å‰‡", btn_home: "ğŸ  å›é¦–é ", btn_done: "å®Œæˆè¨­å®š",
        
        // Dynamic Win Messages
        msg_win: "You Win", msg_lose: "You Lose",
        msg_red_win: "ç´…æ–¹ç²å‹!", msg_black_win: "é»‘æ–¹ç²å‹!",

        rules_html: `<h3>æš—æ£‹è¦å‰‡èªªæ˜</h3><p style="text-align:center; color:#ccc; margin-top:-10px;">æš—è±¡æ£‹ / ç¿»æ£‹</p><h4>1. éŠæˆ²æ€§è³ª</h4><p>é‹æ°£ ï¼‹ ç­–ç•¥</p><h4>2. æ£‹ç›¤èˆ‡åˆå§‹</h4><ul><li><strong>æ£‹ç›¤ï¼š</strong>4 Ã— 8 (å…±32æ ¼)ã€‚</li><li><strong>æ£‹å­ï¼š</strong>å®Œæ•´è±¡æ£‹32å­ (ç´…é»‘å„16)ã€‚</li><li><strong>åˆå§‹ï¼š</strong>æ‰€æœ‰æ£‹å­è“‹ç‰Œæ··æ´—ï¼Œéš¨æ©Ÿæ“ºæ»¿ã€‚</li></ul><h4>3. è¡Œå‹•è¦å‰‡</h4><p>æ¯å›åˆç©å®¶å¯åŸ·è¡Œä¸‹åˆ—<strong>å…¶ä¸­ä¸€é …</strong>ï¼š</p><ul><li>ç¿»é–‹ä¸€é¡†æš—æ£‹ã€‚</li><li>ç§»å‹•ä¸€é¡†å·±æ–¹æ£‹å­ (ä¸Šä¸‹å·¦å³ä¸€æ ¼)ã€‚</li><li>åƒæ‰æ•µæ–¹æ£‹å­ã€‚</li></ul><h4>4. åƒå­å¤§å° (å¤§åƒå°)</h4><p><strong>å°‡(å¸¥) > å£«(ä»•) > è±¡(ç›¸) > è»Š(ä¿¥) > é¦¬(å‚Œ) > åŒ…(ç‚®) > å…µ(å’)</strong></p><p><strong>ç‰¹ä¾‹ï¼š</strong></p><ul><li><strong>å…µ(å’)</strong> å¯ä»¥åƒ <strong>å°‡(å¸¥)</strong>ã€‚</li><li><strong>åŒ…(ç‚®)</strong> ä¸çœ‹å¤§å°ï¼Œéœ€<strong>éš”ä¸€é¡†æ£‹å­</strong>è·³åƒä»»ä½•æ•µå­ã€‚</li></ul><h4>5. å‹åˆ©æ¢ä»¶</h4><ul><li>åƒå…‰å°æ–¹æ‰€æœ‰æ£‹å­ã€‚</li><li>æˆ–è€…è®“å°æ–¹ç„¡è·¯å¯èµ° (å›°æ–ƒ)ã€‚</li></ul><button class="btn btn-red" style="width:100%; margin-top:20px; padding:10px;" onclick="toggleRules()">é—œé–‰èªªæ˜</button>`,
        // New Back Styles translations
        lbl_back: "æ£‹å­èƒŒåœ–",
        "opt-b-default": "âœ¨ é è¨­ (Default)",
        "opt-b-1": "1. ç£¨ç ‚é»‘", "opt-b-2": "2. æ¯›ç»ç’ƒ", "opt-b-3": "3. ç¢³çº–ç¶­", "opt-b-4": "4. é«®çµ²éŠ€", "opt-b-5": "5. æ–°æ“¬æ…‹", "opt-b-6": "6. çš®é©ç¸«ç·š",
        "opt-b-7": "7. åæ‡‰å †", "opt-b-8": "8. æ•…éšœè—è¡“", "opt-b-9": "9. å…¨æ¯ç¶²æ ¼", "opt-b-10": "10. é§­å®¢ä»£ç¢¼", "opt-b-11": "11. éœ“è™¹é‚Šæ¡†",
        "opt-b-12": "12. é»‘é‡‘å¤§ç†çŸ³", "opt-b-13": "13. ç«ç‘°é‡‘", "opt-b-14": "14. é‘½çŸ³åˆ‡é¢", "opt-b-15": "15. æ¶²æ…‹æ°´éŠ€", "opt-b-16": "16. é»‘æ›œçŸ³",
        "opt-b-17": "17. æ°´å¢¨æšˆæŸ“", "opt-b-18": "18. é’èŠ±ç“·", "opt-b-19": "19. æœ±æ¼†é‡‘ç²‰", "opt-b-20": "20. æ¯å±±æ°´", "opt-b-21": "21. é’æµ·æ³¢",
        "opt-b-22": "22. æ·±æµ·å…‰é»", "opt-b-23": "23. å²©æ¼¿è£‚è®Š", "opt-b-24": "24. æ˜Ÿç©ºæ˜Ÿé›²", "opt-b-25": "25. æ¥µå…‰", "opt-b-26": "26. æ°´ç£¨çŸ³",
        "opt-b-27": "27. è¿·å¹»æ¼¸å±¤", "opt-b-28": "28. æ­æ™®è—è¡“", "opt-b-29": "29. å­Ÿè²æ–¯", "opt-b-30": "30. ç´™è—å±¤ç–Š"
    },
    "zh-CN": {
        title: "æš—æ£‹å¤§å¸ˆ 2026",
        p1_name_pvp: "ç©å®¶1", p1_name_pve: "ç©å®¶", p2_name_pvp: "ç©å®¶2", p2_name_pve: "ç”µè„‘",
        my_turn: "è½®åˆ°ä½ ", pc_thinking: "ç”µè„‘æ€è€ƒä¸­...",
        flip_card_pvp1: "ç©å®¶1 ç¿»ç‰Œ", flip_card_pvp2: "ç©å®¶2 ç¿»ç‰Œ", flip_card_pve: "è¯·ç¿»ç‰Œ", flip_card_pc: "ç”µè„‘ç¿»ç‰Œ",
        move_pvp1: "ç©å®¶1 èµ°æ£‹", move_pvp2: "ç©å®¶2 èµ°æ£‹",
        btn_settings: "âš™ï¸ è®¾ç½®", btn_undo: "â†©ï¸ æ‚”æ£‹", btn_restart: "ğŸ”„ é‡å¼€",
        lbl_mode: "å¯¹æˆ˜æ¨¡å¼", opt_pve: "ğŸ’» å•äºº (æŒ‘æˆ˜ç”µè„‘)", opt_pvp: "ğŸ‘¥ åŒäºº (åŒæœºå¯¹å¼ˆ)",
        lbl_theme: "è§†è§‰é£æ ¼",
        opt_t_classic: "ğŸ’ ç»å…¸", opt_t_ink: "ğŸ”ï¸ æ°´å¢¨", opt_t_dark: "ğŸŒƒ æš—é»‘", opt_t_jade: "ğŸ“¿ ç¿¡ç¿ ",
        opt_t_wood: "ğŸªµ çº¢æœ¨", opt_t_gold: "ğŸ‘‘ é»‘é‡‘", opt_t_ocean: "ğŸŒŠ æ·±æµ·", opt_t_royal: "ğŸ›ï¸ ç´«ç¦",
        opt_t_cyber: "ğŸ¤– èµ›åš", opt_t_sakura: "ğŸŒ¸ æ¨±èŠ±", opt_t_vintage: "ğŸ“œ å¤å¤",
        opt_t_ice: "â„ï¸ å†°é›ª", opt_t_stone: "ğŸ—¿ å·¨çŸ³", opt_t_minimal: "â¬œ æç®€",
        lbl_diff: "ç”µè„‘éš¾åº¦ (AI ç­‰çº§)", opt_easy: "ç®€å• (èœé¸Ÿ)", opt_medium: "ä¸­ç­‰ (æ­£å¸¸)", opt_hard: "å›°éš¾ (é«˜æ‰‹)", opt_expert: "ä¸“å®¶ (èŒä¸š)", opt_master: "å¤§å¸ˆ (å®—å¸ˆ)", opt_god: "ç¥ (ä¸å¯æˆ˜èƒœ)",
        lbl_music: "èƒŒæ™¯éŸ³ä¹", opt_mute: "ğŸ”‡ é™éŸ³",
        "opt_m_01": "ğŸµ ä¹æ›² 01", "opt_m_02": "ğŸµ ä¹æ›² 02", "opt_m_03": "ğŸµ ä¹æ›² 03", "opt_m_04": "ğŸµ ä¹æ›² 04", "opt_m_05": "ğŸµ ä¹æ›² 05", "opt_m_06": "ğŸµ ä¹æ›² 06", "opt_m_07": "ğŸµ ä¹æ›² 07",
        lbl_lang: "è¯­è¨€ (Language)",
        lbl_vol_music: "éŸ³ä¹éŸ³é‡", lbl_vol_sfx: "éŸ³æ•ˆéŸ³é‡",
        lbl_ghost: "ğŸ‘» æç¤º", btn_rules: "ğŸ“œ è§„åˆ™", btn_home: "ğŸ  å›é¦–é¡µ", btn_done: "å®Œæˆè®¾ç½®",
        
        msg_win: "æ­å–œèƒœåˆ©!", msg_lose: "å¯æƒœè´¥åŒ—...",
        msg_red_win: "çº¢æ–¹è·èƒœ!", msg_black_win: "é»‘æ–¹è·èƒœ!",

        rules_html: `<h3>æš—æ£‹è§„åˆ™è¯´æ˜</h3><p style="text-align:center; color:#ccc; margin-top:-10px;">æš—è±¡æ£‹ / ç¿»æ£‹</p><h4>1. æ¸¸æˆæ€§è´¨</h4><p>è¿æ°” ï¼‹ ç­–ç•¥</p><h4>2. æ£‹ç›˜ä¸åˆå§‹</h4><ul><li><strong>æ£‹ç›˜ï¼š</strong>4 Ã— 8 (å…±32æ ¼)ã€‚</li><li><strong>æ£‹å­ï¼š</strong>å®Œæ•´è±¡æ£‹32å­ (çº¢é»‘å„16)ã€‚</li><li><strong>åˆå§‹ï¼š</strong>æ‰€æœ‰æ£‹å­ç›–ç‰Œæ··æ´—ï¼Œéšæœºæ‘†æ»¡ã€‚</li></ul><h4>3. è¡ŒåŠ¨è§„åˆ™</h4><p>æ¯å›åˆç©å®¶å¯æ‰§è¡Œä¸‹åˆ—<strong>å…¶ä¸­ä¸€é¡¹</strong>ï¼š</p><ul><li>ç¿»å¼€ä¸€é¢—æš—æ£‹ã€‚</li><li>ç§»åŠ¨ä¸€é¢—å·±æ–¹æ£‹å­ (ä¸Šä¸‹å·¦å³ä¸€æ ¼)ã€‚</li><li>åƒæ‰æ•Œæ–¹æ£‹å­ã€‚</li></ul><h4>4. åƒå­å¤§å° (å¤§åƒå°)</h4><p><strong>å°†(å¸…) > å£«(ä»•) > è±¡(ç›¸) > è»Š(ä¿¥) > é©¬(å‚Œ) > åŒ…(ç‚®) > å…µ(å’)</strong></p><p><strong>ç‰¹ä¾‹ï¼š</strong></p><ul><li><strong>å…µ(å’)</strong> å¯ä»¥åƒ <strong>å°†(å¸…)</strong>ã€‚</li><li><strong>åŒ…(ç‚®)</strong> ä¸çœ‹å¤§å°ï¼Œéœ€<strong>éš”ä¸€é¢—æ£‹å­</strong>è·³åƒä»»ä½•æ•Œå­ã€‚</li></ul><h4>5. èƒœåˆ©æ¡ä»¶</h4><ul><li>åƒå…‰å¯¹æ–¹æ‰€æœ‰æ£‹å­ã€‚</li><li>æˆ–è€…è®©å¯¹æ–¹æ— è·¯å¯èµ° (å›°æ¯™)ã€‚</li></ul><button class="btn btn-red" style="width:100%; margin-top:20px; padding:10px;" onclick="toggleRules()">å…³é—­è¯´æ˜</button>`,
        lbl_back: "æ£‹å­èƒŒå›¾",
        "opt-b-default": "âœ¨ é¢„è®¾ (Default)",
        "opt-b-1": "1. ç£¨ç ‚é»‘", "opt-b-2": "2. æ¯›ç»ç’ƒ", "opt-b-3": "3. ç¢³çº¤ç»´", "opt-b-4": "4. é«®ä¸é“¶", "opt-b-5": "5. æ–°æ‹Ÿæ€", "opt-b-6": "6. çš®é©ç¼çº¿",
        "opt-b-7": "7. ååº”å †", "opt-b-8": "8. æ•…éšœè‰ºæœ¯", "opt-b-9": "9. å…¨æ¯ç¶²æ ¼", "opt-b-10": "10. é»‘å®¢ä»£ç ", "opt-b-11": "11. éœ“è™¹è¾¹æ¡†",
        "opt-b-12": "12. é»‘é‡‘å¤§ç†çŸ³", "opt-b-13": "13. ç«ç‘°é‡‘", "opt-b-14": "14. é’»çŸ³åˆ‡é¢", "opt-b-15": "15. æ¶²æ€æ°´é“¶", "opt-b-16": "16. é»‘æ›œçŸ³",
        "opt-b-17": "17. æ°´å¢¨æ™•æŸ“", "opt-b-18": "18. é’èŠ±ç“·", "opt-b-19": "19. æœ±æ¼†é‡‘ç²‰", "opt-b-20": "20. æ¯å±±æ°´", "opt-b-21": "21. é’æµ·æ³¢",
        "opt-b-22": "22. æ·±æµ·å…‰ç‚¹", "opt-b-23": "23. å²©æµ†è£‚å˜", "opt-b-24": "24. æ˜Ÿç©ºæ˜Ÿäº‘", "opt-b-25": "25. æå…‰", "opt-b-26": "26. æ°´ç£¨çŸ³",
        "opt-b-27": "27. è¿·å¹»æ¸å±‚", "opt-b-28": "28. æ¬§æ™®è‰ºæœ¯", "opt-b-29": "29. å­Ÿè²æ–¯", "opt-b-30": "30. çº¸è‰ºå±‚å "
    },
    "en": {
        title: "Dark Chess 2026",
        p1_name_pvp: "Player 1", p1_name_pve: "You", p2_name_pvp: "Player 2", p2_name_pve: "CPU",
        my_turn: "Your Turn", pc_thinking: "CPU Thinking...",
        flip_card_pvp1: "P1 Flip", flip_card_pvp2: "P2 Flip", flip_card_pve: "Flip a Piece", flip_card_pc: "CPU Flip",
        move_pvp1: "P1 Move", move_pvp2: "P2 Move",
        btn_settings: "âš™ï¸ Settings", btn_undo: "â†©ï¸ Undo", btn_restart: "ğŸ”„ Restart",
        lbl_mode: "Game Mode", opt_pve: "ğŸ’» 1 Player (PvE)", opt_pvp: "ğŸ‘¥ 2 Players (PvP)",
        lbl_theme: "Visual Style",
        opt_t_classic: "ğŸ’ Classic", opt_t_ink: "ğŸ”ï¸ Ink", opt_t_dark: "ğŸŒƒ Dark", opt_t_jade: "ğŸ“¿ Jade",
        opt_t_wood: "ğŸªµ Wood", opt_t_gold: "ğŸ‘‘ Gold", opt_t_ocean: "ğŸŒŠ Ocean", opt_t_royal: "ğŸ›ï¸ Royal",
        opt_t_cyber: "ğŸ¤– Cyber", opt_t_sakura: "ğŸŒ¸ Sakura", opt_t_vintage: "ğŸ“œ Vintage",
        opt_t_ice: "â„ï¸ Ice", opt_t_stone: "ğŸ—¿ Stone", opt_t_minimal: "â¬œ Minimal",
        lbl_diff: "AI Difficulty", opt_easy: "Easy (Novice)", opt_medium: "Medium (Normal)", opt_hard: "Hard (Advanced)", opt_expert: "Expert (Pro)", opt_master: "Master (Grand)", opt_god: "God (Invincible)",
        lbl_music: "BGM", opt_mute: "ğŸ”‡ Mute",
        "opt_m_01": "ğŸµ Track 01", "opt_m_02": "ğŸµ Track 02", "opt_m_03": "ğŸµ Track 03", "opt_m_04": "ğŸµ Track 04", "opt_m_05": "ğŸµ Track 05", "opt_m_06": "ğŸµ Track 06", "opt_m_07": "ğŸµ Track 07",
        lbl_lang: "Language",
        lbl_vol_music: "Music Vol", lbl_vol_sfx: "SFX Vol",
        lbl_ghost: "ğŸ‘» Hints", btn_rules: "ğŸ“œ Rules", btn_home: "ğŸ  Home", btn_done: "Done",
        
        msg_win: "You Win!", msg_lose: "You Lose...",
        msg_red_win: "Red Wins!", msg_black_win: "Black Wins!",

        rules_html: `<h3>Game Rules</h3><p style="text-align:center; color:#ccc; margin-top:-10px;">Dark Chess / Blind Chess</p><h4>1. Game Type</h4><p>Luck + Strategy</p><h4>2. Board & Pieces</h4><ul><li><strong>Board:</strong> 4 Ã— 8 (32 grids).</li><li><strong>Pieces:</strong> Chinese Chess set (32 total).</li><li><strong>Start:</strong> All pieces hidden & shuffled.</li></ul><h4>3. Actions</h4><p>One action per turn:</p><ul><li>Flip a hidden piece.</li><li>Move a piece (1 step adjacent).</li><li>Capture an enemy piece.</li></ul><h4>4. Rank (Capture)</h4><p><strong>King > Advisor > Elephant > Rook > Horse > Cannon > Pawn</strong></p><p><strong>Exceptions:</strong></p><ul><li><strong>Pawn</strong> can capture <strong>King</strong>.</li><li><strong>Cannon</strong> captures by <strong>jumping over exactly one piece</strong>.</li></ul><h4>5. Victory</h4><ul><li>Capture all enemy pieces.</li><li>Or stalemate the opponent.</li></ul><button class="btn btn-red" style="width:100%; margin-top:20px; padding:10px;" onclick="toggleRules()">Close</button>`,
        lbl_back: "Card Back",
        "opt-b-default": "âœ¨ Default",
        "opt-b-1": "1. Matte Black", "opt-b-2": "2. Frosted", "opt-b-3": "3. Carbon", "opt-b-4": "4. Brushed Metal", "opt-b-5": "5. Neumorphism", "opt-b-6": "6. Leather",
        "opt-b-7": "7. Arc Reactor", "opt-b-8": "8. Glitch", "opt-b-9": "9. Hologram", "opt-b-10": "10. Matrix", "opt-b-11": "11. Neon Border",
        "opt-b-12": "12. Black Marble", "opt-b-13": "13. Rose Gold", "opt-b-14": "14. Diamond", "opt-b-15": "15. Liquid Chrome", "opt-b-16": "16. Obsidian",
        "opt-b-17": "17. Ink Wash", "opt-b-18": "18. Porcelain", "opt-b-19": "19. Lacquer", "opt-b-20": "20. Zen Garden", "opt-b-21": "21. Seigaiha",
        "opt-b-22": "22. Bio-Lumi", "opt-b-23": "23. Magma", "opt-b-24": "24. Galaxy", "opt-b-25": "25. Aurora", "opt-b-26": "26. Terrazzo",
        "opt-b-27": "27. Acid", "opt-b-28": "28. Op Art", "opt-b-29": "29. Memphis", "opt-b-30": "30. Paper Cutout"
    }
};

// === Main UI Thread ===
const PIECES_DEF = [
    { name: 'å¸¥', rank: 7, color: 'red', count: 1 }, { name: 'ä»•', rank: 6, color: 'red', count: 2 }, { name: 'ç›¸', rank: 5, color: 'red', count: 2 }, { name: 'ä¿¥', rank: 4, color: 'red', count: 2 }, { name: 'å‚Œ', rank: 3, color: 'red', count: 2 }, { name: 'ç‚®', rank: 2, color: 'red', count: 2 }, { name: 'å…µ', rank: 1, color: 'red', count: 5 },
    { name: 'å°‡', rank: 7, color: 'black', count: 1 }, { name: 'å£«', rank: 6, color: 'black', count: 2 }, { name: 'è±¡', rank: 5, color: 'black', count: 2 }, { name: 'è»Š', rank: 4, color: 'black', count: 2 }, { name: 'é¦¬', rank: 3, color: 'black', count: 2 }, { name: 'åŒ…', rank: 2, color: 'black', count: 2 }, { name: 'å’', rank: 1, color: 'black', count: 5 }
];
const SCORES = { 
    7: 1500, 6: 600, 5: 500, 4: 400, 3: 300, 2: 1000, 1: 200 
};
const LEVELS = {
    'easy':   { time: 500,  depth: 6, errorRate: 0.25, expect: false, enhanced: false, qs: false },
    'medium': { time: 1000, depth: 9, errorRate: 0.1, expect: false, enhanced: false, qs: true },
    'hard':   { time: 2000, depth: 15, errorRate: 0.0, expect: true,  enhanced: true, qs: true },
    'expert': { time: 3000, depth: 25, errorRate: 0.0, expect: true,  enhanced: true,  qs: true },
    'master': { time: 4000, depth: 40, errorRate: 0.0, expect: true,  enhanced: true,  qs: true },
    'god':    { time: 7000, depth: 99, errorRate: 0.0, expect: true,  enhanced: true,  qs: true } 
};

const audio = document.getElementById('bgm');
const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
let userInteracted = false;
let bd = [], myColor = null, turn = 1, curTurnColor = null, sel = -1, lastMove = -1, historyStack = [], over = false, isPVP = false, isAiThinking = false;
let showGhost = true;
let ghostPos = -1;
let ghostPiece = null;
let currentLang = 'zh-TW';
let isAnimating = false;
let dragEl = null;

let worker = null;
let timerInterval = null;
let initialResizeDone = false;
let mouseX = 0, mouseY = 0;

/* --- GitHub Music Logic (From Gomoku) --- */
function getMp3Path(val) {
    if (val === 'none') return "";
    const baseUrl = "https://johsok.github.io/Games/MP3/";
    return `${baseUrl}${val}.mp3`;
}

function initWorker() {
    const blob = new Blob([document.getElementById('worker-script').textContent], {type: 'application/javascript'});
    worker = new Worker(URL.createObjectURL(blob));
    
    worker.onmessage = function(e) {
        setTimeout(() => {
            clearInterval(timerInterval);
            isAiThinking = false;
            const bestM = e.data;
            const aiC = getTurnColor(), opC = aiC==='red'?'black':'red';
            const hid = bd.filter(p => p && p.hidden);
            
            if(!bestM && hid.length > 0) {
                let idxs = bd.map((p,i)=>p&&p.hidden?i:-1).filter(i=>i!==-1);
                actionFlip(idxs[Math.floor(Math.random() * idxs.length)]);
            } else if(bestM) {
                if(bestM.type === 'flip') actionFlip(bestM.from);
                else actionMove(bestM.from, bestM.to);
            } else {
                // AI has no moves -> AI loses. Player wins.
                const t = TRANSLATIONS[currentLang];
                endGame(isPVP ? (opC==='red' ? t.msg_red_win : t.msg_black_win) : t.msg_win);
            }
            updateUI(); 
        }, 500); 
    };
}

window.onload = () => { 
    resizeBoard(); 
    setTimeout(resizeBoard, 300); 
    
    // Init Audio with new logic
    audio.src = getMp3Path(document.getElementById('music-sel').value);
    
    // Init Volumes
    adjMusicVol();
    adjSfxVol();
    updateText(); // Apply language
    
    document.addEventListener('visibilitychange', () => {
        const musicSetting = document.getElementById('music-sel').value;
        if (document.hidden) {
            audio.pause();
        } else {
            if (musicSetting !== 'none' && userInteracted && audio.volume > 0) {
                audio.play().catch(()=>{});
            }
        }
    });

    window.addEventListener('resize', () => {
        if (!initialResizeDone || Math.abs(window.innerWidth - lastWinW) > 20) {
            resizeBoard();
        }
    }); 

    // Global Mouse tracking for drag
    window.addEventListener('mousemove', (e) => {
        mouseX = e.clientX;
        mouseY = e.clientY;
        updateDragPos();
    });
    window.addEventListener('touchmove', (e) => {
        if (e.touches.length > 0) {
            mouseX = e.touches[0].clientX;
            mouseY = e.touches[0].clientY;
            updateDragPos();
        }
    }, {passive: false});

    document.body.addEventListener('click', unlockAudio, {once:true}); 
    document.body.addEventListener('touchstart', unlockAudio, {once:true}); 
    initWorker();
    restart(); 
    audio.addEventListener('ended', () => { 
        if(userInteracted && document.getElementById('music-sel').value !== 'none' && audio.volume > 0) audio.play().catch(()=>{}); 
    }); 
};

function updateDragPos() {
    if (dragEl) {
        dragEl.style.left = mouseX + 'px';
        dragEl.style.top = mouseY + 'px';
    }
}

function unlockAudio() { 
    userInteracted = true; 
    if(audioCtx.state === 'suspended') audioCtx.resume(); 
    
    // Update Volume logic based on range input
    audio.volume = document.getElementById('vol-range').value / 100;
    
    if (!audio.src || audio.src === "") {
        const val = document.getElementById('music-sel').value;
        if(val !== 'none') audio.src = getMp3Path(val);
    }
    
    if(document.getElementById('music-sel').value !== 'none' && audio.volume > 0) {
        audio.play().catch(()=>{}); 
    }
}

let lastWinW = 0;
function resizeBoard() { 
    const isMobileLandscape = window.matchMedia("(orientation: landscape)").matches && window.innerWidth < 1024;
    const winW = isMobileLandscape ? window.outerHeight : window.innerWidth;
    const winH = isMobileLandscape ? window.innerWidth : window.innerHeight;
    lastWinW = window.innerWidth;

    const h = document.getElementById('main-header').offsetHeight;
    const w = winW; 
    const ah = winH - h - 5; 
    
    const r = 4/8; 
    let fw = w, fh = fw/r; 
    if(fh > ah) { fh = ah; fw = fh * r; } 
    
    const bw = document.getElementById('board-wrap'); 
    bw.style.width = fw + "px"; 
    bw.style.height = fh + "px"; 
    bw.style.fontSize = (fw / 4) + "px"; 
    initialResizeDone = true;
}

function restart() {
    let pool = [], id = 0;
    PIECES_DEF.forEach(p => { for(let i=0; i<p.count; i++) pool.push({ ...p, id: id++, hidden: true }); });
    for (let i = pool.length - 1; i > 0; i--) { const j = Math.floor(Math.random() * (i + 1)); [pool[i], pool[j]] = [pool[j], pool[i]]; }
    bd = pool; myColor = null; curTurnColor = null; turn = 1; sel = -1; lastMove = -1; historyStack = []; over = false; isAiThinking = false; isAnimating = false;
    ghostPos = -1; ghostPiece = null;
    if(dragEl) { dragEl.remove(); dragEl = null; }
    isPVP = document.getElementById('mode-sel').value === 'pvp';
    clearInterval(timerInterval);
    document.getElementById('win-overlay').classList.remove('show'); updateUI(); render();
}

function render() {
    const w = document.getElementById('board-wrap'), ov = document.getElementById('win-overlay'); w.innerHTML = ''; w.appendChild(ov);
    
    // Manage dragging element
    if (sel !== -1 && bd[sel] && !bd[sel].hidden) {
        if (!dragEl) {
            dragEl = document.createElement('div');
            let classes = ['piece', 'dragging-piece', bd[sel].color];
            dragEl.className = classes.join(' ');
            dragEl.innerText = bd[sel].name;
            dragEl.style.fontSize = (parseFloat(w.style.fontSize) * 0.65) + "px"; 
            dragEl.style.width = (parseFloat(w.style.fontSize) * 0.95) + "px"; 
            dragEl.style.height = (parseFloat(w.style.fontSize) * 0.95) + "px";
            document.body.appendChild(dragEl);
            updateDragPos();
        }
    } else {
        if (dragEl) { dragEl.remove(); dragEl = null; }
    }

    bd.forEach((p, i) => {
        const c = document.createElement('div'); c.className = 'cell'; c.onclick = () => handleClick(i);
        
        if(p) {
            if (i === sel && !p.hidden) {
                const mark = document.createElement('div');
                mark.className = 'origin-mark';
                c.appendChild(mark);
            } else {
                const el = document.createElement('div');
                let classes = ['piece'];
                classes.push(p.hidden ? 'back' : p.color);
                
                if (!p.hidden) {
                     if (sel !== -1 && i !== sel && isValidMove(sel, i)) {
                         classes.push('can-eat');
                     }
                }
                if (i === lastMove) classes.push('last-move');
                
                el.className = classes.join(' ');
                if (!p.hidden) el.innerText = p.name;
                c.appendChild(el);
            }
        } 
        else if (showGhost && i === ghostPos && ghostPiece) {
            const el = document.createElement('div');
            let classes = ['piece', 'ghost', ghostPiece.color];
            el.className = classes.join(' ');
            el.innerText = ghostPiece.name;
            c.appendChild(el);
        }

        w.appendChild(c);
    });
}

function updateUI() {
    const t = TRANSLATIONS[currentLang];
    const p1 = document.getElementById('p1-status'), p2 = document.getElementById('p2-status'), msg = document.getElementById('msg'), ub = document.getElementById('btn-undo');
    
    if(!myColor) { 
        p1.innerHTML = `<i class="player-dot dot-unk"></i> ${isPVP ? t.p1_name_pvp : t.p1_name_pve}`; 
        p2.innerHTML = `<i class="player-dot dot-unk"></i> ${isPVP ? t.p2_name_pvp : t.p2_name_pve}`; 
    } else {
        const c1 = myColor, c2 = myColor==='red'?'black':'red';
        const colorName1 = c1==='red' ? 'ğŸ”´' : 'âš«';
        const colorName2 = c2==='red' ? 'ğŸ”´' : 'âš«';
        p1.innerHTML = `<i class="player-dot dot-${c1}"></i> ${isPVP ? t.p1_name_pvp : t.p1_name_pve} (${colorName1})`;
        p2.innerHTML = `<i class="player-dot dot-${c2}"></i> ${isPVP ? t.p2_name_pvp : t.p2_name_pve} (${colorName2})`;
    }
    
    if(over) return;
    let txt = "";
    if(!myColor) {
        if(isPVP) txt = turn===1 ? t.flip_card_pvp1 : t.flip_card_pvp2;
        else txt = turn===1 ? t.flip_card_pve : t.flip_card_pc;
    } else { 
        if(isPVP) txt = turn===1 ? t.move_pvp1 : t.move_pvp2; 
        else txt = turn===1 ? t.my_turn : t.pc_thinking; 
    }
    
    if(!isAiThinking && !isAnimating) {
        msg.innerText = txt; msg.style.color = turn===1?"#f1c40f":"#ccc";
        if(turn===-1 && !isPVP) msg.style.color = "#e74c3c";
    }
    ub.disabled = (historyStack.length===0 || over || (!isPVP && turn===-1) || isAnimating);
}

function handleClick(i) {
    if(over || isAiThinking || isAnimating || (!isPVP && turn===-1)) return;
    const p = bd[i];
    
    if(p && p.hidden) { saveState(); actionFlip(i); return; }
    
    if(p && !p.hidden) {
        if (i === sel) {
            sel = -1;
            render();
            playSfx(100, "tap"); 
            return;
        }

        if(curTurnColor && p.color !== getTurnColor()) {
            if(sel !== -1 && isValidMove(sel, i)) { saveState(); actionMove(sel, i); } 
            else playSfx(150, "tap");
            return;
        }
        sel = i; render(); playSfx(300, "tap"); return;
    }
    if(!p && sel !== -1 && isValidMove(sel, i)) { saveState(); actionMove(sel, i); }
}

function getTurnColor() { return !myColor ? null : (turn===1 ? myColor : (myColor==='red'?'black':'red')); }

function actionFlip(i) {
    playSfx(600, "flip"); 
    bd[i].hidden = false; 
    lastMove = i;
    sel = -1;
    ghostPos = -1;
    ghostPiece = null;

    if(!myColor) { const c = bd[i].color; if(turn===1) myColor=c; else myColor=(c==='red'?'black':'red'); curTurnColor=c; }
    endTurn();
}

function actionMove(f, t) { 
    const isAiMove = (!isPVP && turn === -1);
    if (isAiMove) {
        animateAiMove(f, t);
    } else {
        executeMove(f, t);
    }
}

function animateAiMove(f, t) {
    isAnimating = true;
    updateUI();
    const cells = document.getElementsByClassName('cell');
    if (!cells[f] || !cells[t] || !bd[f]) { executeMove(f, t); return; }

    const startRect = cells[f].getBoundingClientRect();
    const endRect = cells[t].getBoundingClientRect();
    const fontSize = document.getElementById('board-wrap').style.fontSize;

    const animEl = document.createElement('div');
    const p = bd[f];
    let classes = ['piece', 'animating-piece', p.color];
    animEl.className = classes.join(' ');
    animEl.innerText = p.name;
    animEl.style.fontSize = (parseFloat(fontSize) * 0.65) + "px";
    animEl.style.width = (parseFloat(fontSize) * 0.95) + "px"; 
    animEl.style.height = (parseFloat(fontSize) * 0.95) + "px";
    
    animEl.style.top = (startRect.top + startRect.height/2 - (parseFloat(fontSize)*0.95)/2) + "px";
    animEl.style.left = (startRect.left + startRect.width/2 - (parseFloat(fontSize)*0.95)/2) + "px";
    
    document.body.appendChild(animEl);

    const originalPiece = cells[f].querySelector('.piece');
    if(originalPiece) originalPiece.style.opacity = 0;

    requestAnimationFrame(() => {
        animEl.style.top = (endRect.top + endRect.height/2 - (parseFloat(fontSize)*0.95)/2) + "px";
        animEl.style.left = (endRect.left + endRect.width/2 - (parseFloat(fontSize)*0.95)/2) + "px";
    });

    setTimeout(() => {
        animEl.remove();
        executeMove(f, t);
        isAnimating = false;
        updateUI();
    }, 600);
}

function executeMove(f, t) {
    const k = bd[t]!==null; 
    playSfx(k?800:400, k?"kill":"move"); 

    ghostPos = f;
    ghostPiece = { ...bd[f] };

    bd[t]=bd[f]; bd[f]=null; 
    sel=-1; 
    lastMove=t; 
    checkWin(); 
    if(!over) endTurn(); 
}

function endTurn() {
    turn = -turn; if(myColor) curTurnColor = (curTurnColor==='red'?'black':'red');
    render(); updateUI();
    if(!isPVP && turn===-1 && !over) { 
        isAiThinking = true; 
        aiRun(); 
    }
}

function isValidMove(f, t, b=bd) {
    const p1 = b[f], p2 = b[t], x1=f&3, y1=f>>2, x2=t&3, y2=t>>2, d=Math.abs(x1-x2)+Math.abs(y1-y2);
    if(p2 && !p2.hidden && p1.color===p2.color) return false;
    
    if(p1.rank===2) { 
        if(!p2) return d===1;
        if(p2.hidden) return false; 
        if(x1!==x2 && y1!==y2) return false;
        let c=0, s=Math.min(f,t)+(y1===y2?1:4), e=Math.max(f,t), st=y1===y2?1:4;
        for(let k=s; k<e; k+=st) if(b[k]) c++;
        return c===1; 
    } else {
        if(d!==1) return false; 
        if(!p2) return true; 
        if(p2.hidden) return false; 
        if(p1.rank===1 && p2.rank===7) return true; 
        if(p1.rank===7 && p2.rank===1) return false;
        return p1.rank >= p2.rank;
    }
}

function checkWin() {
    const t = TRANSLATIONS[currentLang];
    // Calculate pieces count
    const rCnt = bd.filter(p=>p && p.color==='red').length;
    const bCnt = bd.filter(p=>p && p.color==='black').length;

    let winner = null;
    if (rCnt === 0) winner = 'black';
    else if (bCnt === 0) winner = 'red';

    if (winner) {
        if (isPVP) {
            endGame(winner === 'red' ? t.msg_red_win : t.msg_black_win);
        } else {
            // PvE: Compare winner with player's color
            // myColor is set when player flips the first piece
            if (winner === myColor) {
                endGame(t.msg_win);
            } else {
                endGame(t.msg_lose);
            }
        }
    }
}

function endGame(txt){
    over=true;render();updateUI();
    setTimeout(()=>{
        playWinSfx();
        const o=document.getElementById('win-overlay');
        o.innerText=txt;
        o.classList.add('show');
    },500);
}

function aiRun() {
    if(over) return;
    const levelKey = document.getElementById('diff-sel').value;
    const config = LEVELS[levelKey];
    const aiColor = getTurnColor();
    const msgEl = document.getElementById('msg');
    
    let aiBd = bd.map(p=>p?{...p}:null);
    let hid = []; for(let i=0; i<32; i++) if(aiBd[i] && aiBd[i].hidden) hid.push(i);
    let myP = aiBd.filter(p=>p && !p.hidden && p.color===aiColor);

    if(myP.length === 0 && hid.length > 0) {
        setTimeout(() => {
            actionFlip(hid[Math.floor(Math.random() * hid.length)]);
            isAiThinking = false;
            updateUI(); 
        }, 800); 
        return;
    }

    worker.postMessage({ board: aiBd, aiColor: aiColor, config: config, hiddenIndices: hid });

    const startTime = Date.now();
    msgEl.style.color = "#e74c3c";
    clearInterval(timerInterval);
    
    const updateTimer = () => {
        const elapsed = Date.now() - startTime;
        const remain = Math.max(0, (config.time - elapsed) / 1000).toFixed(1);
        msgEl.innerText = `${TRANSLATIONS[currentLang].pc_thinking} (${remain}s)`;
    };
    updateTimer();
    timerInterval = setInterval(updateTimer, 100); 
}

function saveState() { historyStack.push({ bd: bd.map(p=>p?{...p}:null), turn, myColor, curTurnColor, lastMove, over }); }
function undo() {
    if(!historyStack.length || over || isAiThinking || isAnimating) return;
    let s = isPVP ? 1 : 2; if(historyStack.length<s) s=historyStack.length;
    let st=null; for(let i=0; i<s; i++) st=historyStack.pop();
    if(st) { 
        bd=st.bd; turn=st.turn; myColor=st.myColor; curTurnColor=st.curTurnColor; lastMove=st.lastMove; over=st.over; sel=-1; 
        ghostPos = -1; ghostPiece = null;
        if(dragEl) { dragEl.remove(); dragEl = null; }
        document.getElementById('win-overlay').classList.remove('show'); updateUI(); render(); 
    }
}
function toggleSet() { const s=document.getElementById('settings'); s.style.display=s.style.display==='block'?'none':'block'; }
function toggleRules() { const r=document.getElementById('rules-overlay'); r.style.display=r.style.display==='flex'?'none':'flex'; }
function changeTheme() { document.body.className = document.getElementById('theme-sel').value; }
function changeBack() { document.body.setAttribute('data-back', document.getElementById('back-sel').value); }
function changeMode() { isPVP = document.getElementById('mode-sel').value === 'pvp'; restart(); }

function updateText() {
    const t = TRANSLATIONS[currentLang];
    // Static IDs
    document.getElementById('txt-title').innerText = t.title;
    document.getElementById('btn-settings').innerText = t.btn_settings;
    document.getElementById('btn-undo').innerText = t.btn_undo;
    document.getElementById('btn-restart').innerText = t.btn_restart;
    document.getElementById('lbl-mode').innerText = t.lbl_mode;
    document.getElementById('opt-pve').innerText = t.opt_pve;
    document.getElementById('opt-pvp').innerText = t.opt_pvp;
    document.getElementById('lbl-theme').innerText = t.lbl_theme;
    
    // Themes options
    document.getElementById('opt-t-classic').innerText = t.opt_t_classic;
    document.getElementById('opt-t-ink').innerText = t.opt_t_ink;
    document.getElementById('opt-t-dark').innerText = t.opt_t_dark;
    document.getElementById('opt-t-jade').innerText = t.opt_t_jade;
    document.getElementById('opt-t-wood').innerText = t.opt_t_wood;
    document.getElementById('opt-t-gold').innerText = t.opt_t_gold;
    document.getElementById('opt-t-ocean').innerText = t.opt_t_ocean;
    document.getElementById('opt-t-royal').innerText = t.opt_t_royal;
    // New Themes
    document.getElementById('opt-t-cyber').innerText = t.opt_t_cyber;
    document.getElementById('opt-t-sakura').innerText = t.opt_t_sakura;
    document.getElementById('opt-t-vintage').innerText = t.opt_t_vintage;
    document.getElementById('opt-t-ice').innerText = t.opt_t_ice;
    document.getElementById('opt-t-stone').innerText = t.opt_t_stone;
    document.getElementById('opt-t-minimal').innerText = t.opt_t_minimal;

    document.getElementById('lbl-diff').innerText = t.lbl_diff;
    document.getElementById('opt-easy').innerText = t.opt_easy;
    document.getElementById('opt-medium').innerText = t.opt_medium;
    document.getElementById('opt-hard').innerText = t.opt_hard;
    document.getElementById('opt-expert').innerText = t.opt_expert;
    document.getElementById('opt-master').innerText = t.opt_master;
    document.getElementById('opt-god').innerText = t.opt_god;
    document.getElementById('lbl-music').innerText = t.lbl_music;
    document.getElementById('opt-mute').innerText = t.opt_mute;
    
    // Music options (New logic: 01-07)
    document.getElementById('opt-m-01').innerText = t["opt_m_01"];
    document.getElementById('opt-m-02').innerText = t["opt_m_02"];
    document.getElementById('opt-m-03').innerText = t["opt_m_03"];
    document.getElementById('opt-m-04').innerText = t["opt_m_04"];
    document.getElementById('opt-m-05').innerText = t["opt_m_05"];
    document.getElementById('opt-m-06').innerText = t["opt_m_06"];
    document.getElementById('opt-m-07').innerText = t["opt_m_07"];

    document.getElementById('lbl-lang').innerText = t.lbl_lang;
    document.getElementById('lbl-ghost').innerText = t.lbl_ghost;
    document.getElementById('btn-rules').innerText = t.btn_rules;
    document.getElementById('btn-home').innerText = t.btn_home;
    document.getElementById('btn-done').innerText = t.btn_done;
    document.getElementById('rules-content').innerHTML = t.rules_html;
    
    // New Back Styles
    document.getElementById('lbl-back').innerText = t.lbl_back;
    document.getElementById('opt-b-default').innerText = t["opt-b-default"];
    
    // Update all 30 options
    for(let i=1; i<=30; i++) {
        const key = "opt-b-" + i;
        if(document.getElementById(key)) document.getElementById(key).innerText = t[key];
    }

    // Dynamic Labels handled by adj functions
    adjMusicVol();
    adjSfxVol();
    updateUI(); // Refresh Status Bar
}

function changeLang() {
    currentLang = document.getElementById('lang-sel').value;
    updateText();
}

function adjMusicVol() { 
    const v = document.getElementById('vol-range').value; 
    document.getElementById('lbl-vol-music').innerText = `${TRANSLATIONS[currentLang].lbl_vol_music} (${v}%)`;
    audio.volume = v / 100;
}

function adjSfxVol() {
    const v = document.getElementById('sfx-vol-range').value;
    document.getElementById('lbl-vol-sfx').innerText = `${TRANSLATIONS[currentLang].lbl_vol_sfx} (${v}%)`;
}

function changeMusic() {
    if(!userInteracted) unlockAudio();
    const val = document.getElementById('music-sel').value; 
    
    if(val === 'none') { 
        audio.pause(); 
        audio.src = ""; 
    } else { 
        const newPath = getMp3Path(val);
        if (audio.src !== newPath) {
            audio.src = newPath;
            audio.load();
            audio.play().catch(e => {
                console.log("è‡ªå‹•æ’­æ”¾è¢«æ””æˆªï¼Œç­‰å¾…ä½¿ç”¨è€…é»æ“Š", e);
            });
        }
    } 
}

function toggleGhost() { showGhost = document.getElementById('ghost-check').checked; render(); }

function playSfx(f,t) { 
    if(audioCtx.state==='suspended') audioCtx.resume(); 
    const v = document.getElementById('sfx-vol-range').value / 100; 
    if(v<=0.01) return;
    
    const o=audioCtx.createOscillator(), g=audioCtx.createGain(); o.connect(g); g.connect(audioCtx.destination);
    const n=audioCtx.currentTime;
    if(t==="tap") { o.type="sine"; o.frequency.setValueAtTime(800,n); g.gain.setValueAtTime(v*0.5,n); g.gain.exponentialRampToValueAtTime(0.001,n+0.05); o.start(); o.stop(n+0.05); }
    else if(t==="flip") { o.type="triangle"; o.frequency.setValueAtTime(300,n); o.frequency.linearRampToValueAtTime(600,n+0.1); g.gain.setValueAtTime(v,n); g.gain.exponentialRampToValueAtTime(0.001,n+0.15); o.start(); o.stop(n+0.15); }
    else if(t==="kill") { o.type="square"; o.frequency.setValueAtTime(150,n); g.gain.setValueAtTime(v,n); g.gain.exponentialRampToValueAtTime(0.001,n+0.2); o.start(); o.stop(n+0.2); }
    else { o.frequency.setValueAtTime(f,n); o.frequency.exponentialRampToValueAtTime(f/2,n+0.1); g.gain.setValueAtTime(v,n); g.gain.exponentialRampToValueAtTime(0.001,n+0.15); o.start(); o.stop(n+0.15); }
}

function playWinSfx() { if(audioCtx.state==='suspended') audioCtx.resume(); const v=document.getElementById('sfx-vol-range').value/100; if(v<=0.01) return; const ns=[523.25,659.25,783.99,1046.50,1318.51,1567.98]; const n=audioCtx.currentTime; ns.forEach((x,i)=>{ const o=audioCtx.createOscillator(), g=audioCtx.createGain(); o.type="triangle"; o.connect(g); g.connect(audioCtx.destination); o.frequency.value=x; g.gain.setValueAtTime(0,n+i*0.1); g.gain.linearRampToValueAtTime(v*0.5,n+i*0.1+0.05); g.gain.exponentialRampToValueAtTime(0.001,n+i*0.1+0.3); o.start(n+i*0.1); o.stop(n+i*0.1+0.3); }); }

// Feature: Go Home
function goHome() {
    try {
        if (window.parent && typeof window.parent.closeGame === 'function') {
            window.parent.closeGame();
        } else {
             console.log("No parent detected or standalone mode");
             // window.history.back(); 
        }
    } catch (e) {
        console.error("Cross-origin restriction or error:", e);
    }
}

// 1. ç¦ç”¨å³éµé¸å–®
    document.addEventListener('contextmenu', event => {
        event.preventDefault();
    });

    // 2. ç›£æ§éµç›¤äº‹ä»¶ï¼šç¦ç”¨é–‹ç™¼è€…å¸¸ç”¨å¿«æ·éµ
    document.onkeydown = function(e) {
        // ç¦æ­¢ F12 (123)
        if (e.keyCode == 123) {
            return false;
        }
        // ç¦æ­¢ Ctrl+Shift+I (æª¢æŸ¥å…ƒä»¶)
        if (e.ctrlKey && e.shiftKey && e.keyCode == 'I'.charCodeAt(0)) {
            return false;
        }
        // ç¦æ­¢ Ctrl+Shift+C (é¸å–å…ƒä»¶)
        if (e.ctrlKey && e.shiftKey && e.keyCode == 'C'.charCodeAt(0)) {
            return false;
        }
        // ç¦æ­¢ Ctrl+Shift+J (é–‹ç™¼è€…ä¸»æ§å°)
        if (e.ctrlKey && e.shiftKey && e.keyCode == 'J'.charCodeAt(0)) {
            return false;
        }
        // ç¦æ­¢ Ctrl+U (æŸ¥çœ‹ç¶²é åŸå§‹ç¢¼)
        if (e.ctrlKey && e.keyCode == 'U'.charCodeAt(0)) {
            return false;
        }
        // ç¦æ­¢ Ctrl+S (å­˜æª”)
        if (e.ctrlKey && e.keyCode == 'S'.charCodeAt(0)) {
            return false;
        }
    };

    // 3. é¡å¤–é˜²è­·ï¼šå¦‚æœç©å®¶æ‰“é–‹ä¸»æ§å°ï¼Œçµ¦äºˆæç¤ºæˆ–æ¸…ç†
    // é›–ç„¶ç„¡æ³•é˜»æ­¢é«˜æ‰‹ï¼Œä½†å°æ™®é€šäººå¾ˆæœ‰æ•ˆ
    console.log("%cç³»çµ±å®‰å…¨ç›£æ§ä¸­", "color: red; font-size: 30px; font-weight: bold;");
    console.log("%cæœªç¶“æˆæ¬Šç¦æ­¢æŸ¥çœ‹ç¨‹å¼ç¢¼ï¼", "color: gray; font-size: 20px;");
</script>
</body>
</html>