<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="theme-color" content="#3a3a3a">
    <title>æ‹¼åœ–å¤§å¸« 2026</title>
    <link rel="manifest" id="manifest-placeholder">
    <style>
        /* === æ ¸å¿ƒè®Šæ•¸èˆ‡é…è‰²å®šç¾© === */
        :root {
            --bg-grad: radial-gradient(circle at center, #3a3a3a, #1a1a1a);
            --board-bg: #e0c38c;
            --board-texture: repeating-linear-gradient(45deg, rgba(0,0,0,0.03) 0px, rgba(0,0,0,0.03) 2px, transparent 2px, transparent 4px);
            --line-color: #5d4037;
            --border-style: 8px solid #5d4037;
            --safe-top: env(safe-area-inset-top, 0px); 
            --safe-left: env(safe-area-inset-left, 0px);
            --safe-right: env(safe-area-inset-right, 0px);
        }

        /* === è¦–è¦ºé¢¨æ ¼å®šç¾© === */
        body.t-classic { --bg-grad: radial-gradient(circle, #3e2723 0%, #1a0f0d 100%); --board-bg: #deb887; --line-color: #5d4037; --border-style: 10px ridge #6d4c41; }
        body.t-ink { --bg-grad: linear-gradient(to bottom, #cfd9df 0%, #e2ebf0 100%); --board-bg: #f5f5f5; --board-texture: none; --line-color: #424242; --border-style: 8px double #424242; }
        body.t-jade { --bg-grad: radial-gradient(circle, #004d40, #00251a); --board-bg: #80cbc4; --line-color: #004d40; --border-style: 10px inset #00695c; }
        body.t-wood { --bg-grad: linear-gradient(135deg, #4e342e, #1b100d); --board-bg: #8d6e63; --line-color: #3e2723; --border-style: 10px groove #4e342e; }
        body.t-gold { --bg-grad: radial-gradient(circle, #2b2b2b, #000); --board-bg: #111; --line-color: #ffd700; --border-style: 8px solid #ffd700; }
        body.t-ocean { --bg-grad: linear-gradient(to bottom, #0d47a1, #000051); --board-bg: #1976d2; --line-color: #bbdefb; --border-style: 8px double #90caf9; }
        body.t-royal { --bg-grad: linear-gradient(135deg, #4a148c, #1a0033); --board-bg: #7b1fa2; --line-color: #e1bee7; --border-style: 8px solid #4a0072; }
        body.t-beast { --bg-grad: radial-gradient(circle, #d35400, #2c3e50); --board-bg: #e67e22; --line-color: #5e3105; --border-style: 10px dashed #8e44ad; }
        body.t-playful { --bg-grad: linear-gradient(120deg, #ff9a9e 0%, #fecfef 99%, #fecfef 100%); --board-bg: #fff0f5; --line-color: #ff69b4; --border-style: 8px dotted #ff69b4; }
        body.t-shan { --bg-grad: linear-gradient(to top, #cfd9df 0%, #e2ebf0 100%); --board-bg: #d7e4e8; --line-color: #5d6d7e; --border-style: 8px double #5d6d7e; }
        body.t-cute { --bg-grad: linear-gradient(to right, #a1c4fd 0%, #c2e9fb 100%); --board-bg: #e0f7fa; --line-color: #4dd0e1; --border-style: 10px solid #b39ddb; }
        body.t-cyber { --bg-grad: repeating-linear-gradient(90deg, #111 0px, #111 2px, #000 2px, #000 40px); --board-bg: #050505; --board-texture: none; --line-color: #0ff; --border-style: 8px solid #0ff; }
        body.t-sketch { --bg-grad: #fff; --board-bg: #fff; --board-texture: none; --line-color: #222; --border-style: 6px solid #222; }
        body.t-dark { --bg-grad: linear-gradient(135deg, #232526, #414345); --board-bg: #333; --board-texture: none; --line-color: #777; --border-style: 8px solid #555; }

        html, body { height: 100%; width: 100%; overflow: hidden; overscroll-behavior: none; }
        
        body { 
            font-family: "Microsoft JhengHei", "PingFang TC", sans-serif; 
            background: var(--bg-grad); 
            margin: 0; 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            justify-content: center;
            color: white; 
            transition: background 0.5s; 
            touch-action: none; 
            box-sizing: border-box; 
        }

        /* === é ‚éƒ¨ UI === */
        header { 
            width: 100%; height: auto; display: flex; flex-direction: column; 
            align-items: center; justify-content: center; gap: 4px; flex-shrink: 0; 
            z-index: 100; padding: calc(var(--safe-top) + 8px) 0 8px 0; 
            background: rgba(0,0,0,0.3); backdrop-filter: blur(8px); 
            border-bottom: 1px solid rgba(255,255,255,0.1); box-shadow: 0 4px 10px rgba(0,0,0,0.2); 
            /* å›ºå®š Header çš„å®šä½å±¬æ€§ï¼Œç¢ºä¿åˆ‡æ›ä¸»é¡Œæ™‚ä¸è·³å‹• */
            position: relative;
            box-sizing: border-box;
            transition: background 0.3s;
        }

        .header-top { display: flex; align-items: center; justify-content: center; gap: 15px; width: 95%; max-width: 600px; }
        h2 { font-size: 1.1rem; margin: 0; letter-spacing: 1px; text-shadow: 0 2px 4px rgba(0,0,0,0.8); white-space: nowrap; font-weight: 700; }
        .status { color: #f1c40f; font-weight: bold; font-size: 0.9rem; text-shadow: 0 1px 3px rgba(0,0,0,0.9); line-height: 1.4; }

        .btn-group { display: flex; gap: 8px; align-items: center; }
        .btn { background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); color: #f0f0f0; padding: 5px 12px; border-radius: 20px; cursor: pointer; font-size: 0.85rem; transition: all 0.2s; white-space: nowrap; backdrop-filter: blur(4px); box-shadow: 0 2px 5px rgba(0,0,0,0.2); }
        .btn:active { transform: scale(0.95); background: rgba(255,255,255,0.2); }
        .btn-red { background: rgba(220, 50, 50, 0.85); border: none; }
        .btn-undo { background: rgba(230, 140, 20, 0.85); border: none; }
        
        /* åœ–ç‰‡æç¤ºæŒ‰éˆ•æ¨£å¼ (åœ¨è¨­å®šé¢æ¿ä¸­ä½¿ç”¨) */
        .btn-hint { background: #e67e22; border: none; font-size: 0.8rem; padding: 4px 10px; height: 38px; border-radius: 8px; }

        /* === æ©«å‘ UI === */
        body.is-landscape { flex-direction: row; padding-left: var(--safe-left); padding-right: var(--safe-right); justify-content: center; }
        body.is-landscape header { width: 140px; height: 100vh; padding: 0; border-bottom: none; border-right: 1px solid rgba(255,255,255,0.1); justify-content: center; flex-direction: column; gap: 20px; background: rgba(0,0,0,0.4); }
        body.is-landscape .header-top { flex-direction: column; width: 100%; gap: 10px; margin: 0; }
        body.is-landscape h2 { white-space: normal; text-align: center; }
        body.is-landscape .status { font-size: 1rem; margin-bottom: 10px; text-align: center; }
        body.is-landscape .btn-group { flex-direction: column; width: 100%; gap: 15px; }
        body.is-landscape .btn { width: 80%; text-align: center; padding: 10px 0; }

        /* === è¨­å®šé¢æ¿ === */
        #settings { 
            display: none; 
            position: fixed; 
            top: 50%; left: 50%; 
            transform: translate(-50%, -50%); 
            z-index: 2000; 
            background: rgba(30, 30, 30, 0.95); 
            width: 340px; 
            padding: 20px; 
            border-radius: 16px; 
            box-shadow: 0 20px 60px rgba(0,0,0,0.9); 
            border: 1px solid rgba(255,255,255,0.1); 
            max-height: 90vh; 
            overflow-y: auto; 
            box-sizing: border-box; 
        }
        .set-row { margin-bottom: 12px; }
        .flex-split { display: flex; gap: 10px; justify-content: space-between; }
        .flex-split > div { flex: 1; display: flex; flex-direction: column; }
        .vol-row > div { padding: 0 10px; } 
        label { font-size: 0.85rem; margin-bottom: 5px; color: #aaa; display: block; }
        .vol-hint { color: #f1c40f; font-weight: bold; margin-left: 4px; }
        select, input[type=range] { width: 100%; padding: 8px; border-radius: 8px; border: 1px solid #555; background: #222; color: #fff; height: 38px; box-sizing: border-box;}

        /* === éŠæˆ²å®¹å™¨èˆ‡æ‹¼åœ–å€ === */
        #game-container { flex-shrink: 1; flex-grow: 1; display: flex; justify-content: center; align-items: center; overflow: hidden; position: relative; width: 100%; box-sizing: border-box; }
        body.is-landscape #game-container { width: auto; height: 100vh; flex-grow: 0; }
        
        .board-wrap { 
            position: relative; background: var(--board-bg); background-image: var(--board-texture); 
            border: var(--border-style); border-radius: 6px; 
            box-shadow: 0 20px 50px rgba(0,0,0,0.7), inset 0 0 60px rgba(0,0,0,0.2); 
            padding: 0; 
            box-sizing: border-box; flex-shrink: 0; transition: all 0.3s ease;
        }
        
        .board-inner { position: relative; width: 100%; height: 100%; overflow: hidden; border-radius: 2px; }
        
        /* æ‹¼åœ–å¡Šæ¨£å¼ */
        .tile {
            position: absolute;
            background-repeat: no-repeat;
            box-sizing: border-box;
            border: 1px solid rgba(255, 255, 255, 0.2);
            transition: top 0.2s, left 0.2s, transform 0.1s, box-shadow 0.2s;
            cursor: pointer;
            z-index: 10;
        }
        .tile:hover { z-index: 20; border-color: rgba(255,255,255,0.6); }
        .tile.selected {
            z-index: 30;
            box-shadow: 0 0 15px #f1c40f, inset 0 0 5px #f1c40f;
            border: 2px solid #f1c40f;
            transform: scale(1.02);
        }

        /* è¨˜æ†¶é è¦½å±¤ */
        #preview-layer {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.7);
            z-index: 500;
            display: none;
            justify-content: center; align-items: center;
            opacity: 0; transition: opacity 0.5s;
        }
        #preview-layer.show { display: flex; opacity: 1; }
        #preview-img {
            max-width: 80%; max-height: 80%;
            border: 5px solid #fff;
            box-shadow: 0 0 30px rgba(0,0,0,0.8);
            /* animation ç”± JS æ§åˆ¶ */
        }
        
        /* é—œé–‰æŒ‰éˆ•æ¨£å¼ */
        #hint-close-btn {
            position: absolute; 
            top: 15px; right: 15px; 
            width: 44px; height: 44px;
            background: rgba(220, 20, 20, 0.9);
            color: #fff;
            border: 3px solid #fff;
            border-radius: 50%;
            font-size: 24px;
            font-weight: bold;
            display: none; /* é è¨­éš±è—ï¼Œåªæœ‰åœ¨æç¤ºæ¨¡å¼é¡¯ç¤º */
            cursor: pointer;
            z-index: 600;
            box-shadow: 0 4px 10px rgba(0,0,0,0.5);
            line-height: 38px; /* å‚ç›´ç½®ä¸­ */
            text-align: center;
            transition: transform 0.1s;
        }
        #hint-close-btn:active { transform: scale(0.9); }

        @keyframes memorize {
            0% { transform: rotate(-5deg) scale(0.8); opacity: 0; }
            20% { transform: rotate(0deg) scale(1); opacity: 1; }
            80% { transform: rotate(0deg) scale(1); opacity: 1; }
            100% { transform: rotate(5deg) scale(1.1); opacity: 0; }
        }

        #win-overlay { 
            position: absolute; top: 50%; left: 50%; 
            transform: translate(-50%,-50%); 
            width: 80%; height: 80%;
            display: flex; justify-content: center; align-items: center; text-align: center;
            pointer-events: none; opacity: 0; z-index: 1000; 
            font-family: "Microsoft JhengHei", sans-serif; font-weight: 900; 
            font-size: calc(var(--board-size, 300px) * 0.12);
            letter-spacing: calc(var(--board-size, 300px) * 0.01); 
            color: #fff; text-shadow: 0 0 10px #0ff, 0 0 20px #0ff, 0 0 40px #0ff; 
            line-height: 1.2;
        }
        #win-overlay.show { opacity: 1; animation: win 2.5s ease-in-out infinite; }
        @keyframes win { 
            0% { transform: translate(-50%,-50%) scale(0.5); opacity: 0; } 
            20%, 100% { transform: translate(-50%,-50%) scale(1) rotate(-3deg); opacity: 1; } 
            60% { transform: translate(-50%,-52%) scale(1) rotate(3deg); } 
        }

        #rules-modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); z-index: 3000; justify-content: center; align-items: center; }
        .rules-content { background: #2b2b2b; width: 90%; max-width: 500px; border-radius: 12px; padding: 25px; color: #ddd; }
        .rules-content h3 { color: #f1c40f; text-align: center; border-bottom: 1px solid #555; padding-bottom: 10px;}
        .close-rules { width: 100%; padding: 10px; background: #cc0000; color: #fff; border: none; border-radius: 8px; margin-top: 20px; cursor: pointer; font-weight: bold;}
    </style>
</head>
<body class="t-classic">

<header id="main-header">
    <div class="header-top">
        <h2 id="app-title">æ‹¼åœ–å¤§å¸« 2026</h2>
        <div class="status" id="msg">é¸æ“‡åœ–ç‰‡é–‹å§‹</div>
    </div>
    <div class="btn-group">
        <button class="btn" id="btn-settings" onclick="toggleSet()">âš™ï¸ è¨­å®š</button>
        <button class="btn btn-undo" id="btn-undo" onclick="undo()">â†©ï¸ å¾©åŸ</button>
        <button class="btn btn-red" id="btn-restart" onclick="restart()">ğŸ”„ é‡é–‹</button>
    </div>
</header>

<div id="settings">
    <div class="set-row flex-split">
        <div>
            <label id="lbl-diff">é›£åº¦ç­‰ç´š</label>
            <select id="diff-sel" onchange="changeDiff()">
                <option value="3">3 x 3</option>
                <option value="4" selected>4 x 4 (é è¨­)</option>
                <option value="5">5 x 5</option>
                <option value="7">7 x 7</option>
                <option value="9">9 x 9</option>
                <option value="12">12 x 12</option>
            </select>
        </div>
        <div>
            <label id="lbl-theme">è¦–è¦ºé¢¨æ ¼</label>
            <select id="theme-sel" onchange="changeTheme()">
                <option value="t-classic">ğŸ’ ç¶“å…¸</option>
                <option value="t-ink">ğŸ”ï¸ æ°´å¢¨</option>
                <option value="t-jade">ğŸ“¿ ç¿¡ç¿ </option>
                <option value="t-wood">ğŸªµ ç´…æœ¨</option>
                <option value="t-gold">ğŸ‘‘ é»‘é‡‘</option>
                <option value="t-ocean">ğŸŒŠ æ·±æµ·</option>
                <option value="t-royal">ğŸ›ï¸ ç´«ç¦</option>
                <option value="t-beast">ğŸ¦ é‡ç¸</option>
                <option value="t-playful">ğŸˆ ä¿çš®</option>
                <option value="t-shan">ğŸ–Œï¸ å±±æ°´</option>
                <option value="t-cute">ğŸ¬ å¯æ„›</option>
                <option value="t-cyber">ğŸ¤– è³½åš</option>
                <option value="t-sketch">âœï¸ ç´ æ</option>
                <option value="t-dark">ğŸŒƒ æš—é»‘</option>
            </select>
        </div>
    </div>

    <div class="set-row">
        <label id="lbl-img">é—œå¡åœ–ç‰‡</label>
        <div style="display: flex; gap: 10px; width: 100%;">
            <select id="img-sel" onchange="changeImage()" style="flex: 1; width: 0;">
                </select>
            <button class="btn btn-hint" id="btn-hint" onclick="showHint()" style="flex: 1; width: 0; margin-left: auto; display:flex; align-items:center; justify-content:center;">ğŸ‘ï¸ åœ–ç‰‡æç¤º</button>
        </div>
    </div>

    <div class="set-row flex-split">
        <div>
            <label id="lbl-music">èƒŒæ™¯éŸ³æ¨‚</label>
            <select id="music-sel" onchange="changeMusic()">
                <option value="none">ğŸ”‡ éœéŸ³</option>
                <option value="01">ğŸµ æ¨‚æ›² 01</option>
                <option value="02">ğŸµ æ¨‚æ›² 02</option>
                <option value="03">ğŸµ æ¨‚æ›² 03</option>
                <option value="04"  selected>ğŸµ æ¨‚æ›² 04</option>
                <option value="05">ğŸµ æ¨‚æ›² 05</option>
                <option value="06">ğŸµ æ¨‚æ›² 06</option>
                <option value="07">ğŸµ æ¨‚æ›² 07</option>
            </select>
        </div>
        <div>
            <label id="lbl-lang">èªè¨€</label>
            <select id="lang-sel" onchange="changeLang()">
                <option value="tw" selected>ç¹ä¸­</option>
                <option value="cn">ç®€ä¸­</option>
                <option value="en">English</option>
            </select>
        </div>
    </div>

    <div class="set-row flex-split vol-row">
        <div>
            <label id="lbl-vol-bgm">éŸ³æ¨‚éŸ³é‡<span id="bgm-val-hint" class="vol-hint">20</span></label>
            <input type="range" id="bgm-vol" min="0" max="100" value="20" oninput="adjBgm()">
        </div>
        <div>
            <label id="lbl-vol-sfx">éŸ³æ•ˆéŸ³é‡<span id="sfx-val-hint" class="vol-hint">50</span></label>
            <input type="range" id="sfx-vol" min="0" max="100" value="50" oninput="adjSfx()">
        </div>
    </div>
    
    <div class="set-row flex-split" style="margin-top:10px;">
        <button class="btn" id="btn-rules" onclick="toggleRules()" style="flex:1; background:#2c3e50; padding: 10px;">ğŸ“– è¦å‰‡</button>
        <button class="btn" id="btn-home" onclick="goHome()" style="flex:1; background:#c0392b; padding: 10px;">ğŸ  å›é¦–é </button>
    </div>

    <button class="btn" id="btn-done" style="width:100%; background:#444; padding: 10px; margin-top:10px;" onclick="toggleSet()">å®Œæˆè¨­å®š</button>
</div>

<div id="rules-modal">
    <div class="rules-content">
        <h3 id="rules-title">æ‹¼åœ–è¦å‰‡</h3>
        <p id="rules-p-nature">è€ƒé©—è¨˜æ†¶èˆ‡è§€å¯ŸåŠ›çš„åœ–ç‰‡é‚„åŸéŠæˆ²ã€‚</p>
        <ul id="rules-ul-basic" style="padding-left: 20px; line-height: 1.6;">
            <li>éŠæˆ²é–‹å§‹å‰ï¼Œå®Œæ•´åœ–ç‰‡æœƒæ—‹è½‰å±•ç¤º 3 ç§’ï¼Œè«‹è¨˜ä½å®ƒï¼</li>
            <li>èƒŒæ™¯ä¸­çš„åœ–ç‰‡å·²è¢«éš¨æ©Ÿæ‰“äº‚ã€‚</li>
            <li>é»æ“Šä¸€å€‹æ–¹å¡Šé¸å–ï¼Œå†é»æ“Šå¦ä¸€å€‹æ–¹å¡Šé€²è¡Œ<b>äº¤æ›</b>ã€‚</li>
            <li>å°‡æ‰€æœ‰æ–¹å¡Šé‚„åŸåˆ°æ­£ç¢ºä½ç½®å³å¯ç²å‹ã€‚</li>
        </ul>
        <button class="close-rules" id="btn-close-rules" onclick="toggleRules()">é—œé–‰èªªæ˜</button>
    </div>
</div>

<div id="game-container">
    <div class="board-wrap" id="board-wrap">
        <div class="board-inner" id="board">
            <div id="tiles-container"></div>
            <div id="win-overlay"></div>
            <div id="preview-layer">
                <img id="preview-img" src="" alt="Preview">
                <button id="hint-close-btn" onclick="closeHint()">âœ•</button>
            </div>
        </div>
    </div>
</div>

<audio id="bgm" loop></audio>

<script>
/* === PWA æ”¯æ´ === */
const manifestJSON = {
    name: "æ‹¼åœ–å¤§å¸« 2026", short_name: "æ‹¼åœ–", display: "standalone",
    background_color: "#3a3a3a", theme_color: "#3a3a3a",
    icons: [{"src": "data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAxMDAgMTAwIj48cmVjdCB4PSIxMCIgeT0iMTAiIHdpZHRoPSI4MCIgaGVpZ2h0PSI4MCIgZmlsbD0iI2UzYjU1MSIvPjxwYXRoIGQ9Ik01MCAxMCBWOTAgTTEwIDUwIEg5MCIgc3Ryb2tlPSIjZmZmIiBzdHJva2Utd2lkdGg9IjUiLz48L3N2Zz4=", "sizes": "192x192", "type": "image/svg+xml"}]
};
document.getElementById('manifest-placeholder').setAttribute('href', 'data:application/manifest+json;charset=utf-8,' + encodeURIComponent(JSON.stringify(manifestJSON)));

/* === åœ–ç‰‡è¨­å®šå€ (ä½¿ç”¨ GitHub è·¯å¾‘) === */
const IMAGE_FILES = [
    "01.jpg", "02.jpg", "03.jpg", "04.jpg", "05.jpg", "06.jpg", "07.jpg", "08.jpg", "09.jpg", "10.jpg",
    "11.jpg", "12.jpg", "13.jpg", "14.jpg", "15.jpg", "16.jpg", "17.jpg", "18.jpg", "19.jpg", "20.jpg",
    "21.jpg", "22.jpg"
];
// è¨­å®š GitHub å‰ç¶´
const IMG_PATH_PREFIX = "https://johsok.github.io/Games/Pictures/";
// é—œé–‰ä½”ä½åœ–ï¼Œå¼·åˆ¶ä½¿ç”¨ä¸Šè¿°è·¯å¾‘
const USE_PLACEHOLDER = false; 

/* === éŠæˆ²è®Šæ•¸ === */
let gridSize = 4; // é è¨­ 4x4
let tiles = []; // å„²å­˜ç›®å‰çš„æ‹¼åœ–ç‹€æ…‹ (å€¼ç‚ºåŸå§‹ç´¢å¼•)
let currentImgUrl = "";
let selectedIdx = -1; // ç›®å‰é¸å–çš„æ–¹å¡Š
let isLocked = false; // æ˜¯å¦é–å®šæ“ä½œ (é è¦½æ™‚)
let historyStack = [];
let currentLang = 'tw';
let userInteracted = false;

const audio = document.getElementById('bgm'), audioCtx = new (window.AudioContext || window.webkitAudioContext)();

// ç¿»è­¯æª”
const TRANSLATIONS = {
    tw: { 
        title: "æ‹¼åœ–å¤§å¸« 2026", msgStart: "è«‹é»æ“Šä»»æ„å…©å¡Šé€²è¡Œäº¤æ›", msgWin: "æ‹¼ åœ– å®Œ æˆ !", msgMemo: "è¨˜æ†¶æ™‚é–“...", 
        random: "ğŸ² éš¨æ©Ÿåœ–ç‰‡", diff: "é›£åº¦ç­‰ç´š", img: "é—œå¡åœ–ç‰‡", undo: "å¾©åŸ", rules: "è¦å‰‡", home: "å›é¦–é ",
        theme: "è¦–è¦ºé¢¨æ ¼", music: "èƒŒæ™¯éŸ³æ¨‚", settings: "è¨­å®š", hint: "åœ–ç‰‡æç¤º", 
        done: "å®Œæˆè¨­å®š", closeRules: "é—œé–‰èªªæ˜", volBgm: "éŸ³æ¨‚éŸ³é‡", volSfx: "éŸ³æ•ˆéŸ³é‡"
    },
    cn: { 
        title: "æ‹¼å›¾å¤§å¸ˆ 2026", msgStart: "è¯·ç‚¹å‡»ä»»æ„ä¸¤å—è¿›è¡Œäº¤æ¢", msgWin: "æ‹¼ å›¾ å®Œ æˆ !", msgMemo: "è®°å¿†æ—¶é—´...", 
        random: "ğŸ² éšæœºå›¾ç‰‡", diff: "éš¾åº¦ç­‰çº§", img: "å…³å¡å›¾ç‰‡", undo: "æ’¤é”€", rules: "è§„åˆ™", home: "å›é¦–é¡µ",
        theme: "è§†è§‰é£æ ¼", music: "èƒŒæ™¯éŸ³ä¹", settings: "è®¾ç½®", hint: "å›¾ç‰‡æç¤º", 
        done: "å®Œæˆè®¾ç½®", closeRules: "å…³é—­è¯´æ˜", volBgm: "éŸ³ä¹éŸ³é‡", volSfx: "éŸ³æ•ˆéŸ³é‡"
    },
    en: { 
        title: "Puzzle Master", msgStart: "Click two tiles to swap", msgWin: "SOLVED!", msgMemo: "Memorize...", 
        random: "ğŸ² Random", diff: "Difficulty", img: "Level Image", undo: "Undo", rules: "Rules", home: "Home",
        theme: "Theme", music: "Music", settings: "Settings", hint: "Image Hint", 
        done: "Done", closeRules: "Close", volBgm: "BGM Volume", volSfx: "SFX Volume"
    }
};

/* --- githubéŸ³æ¨‚è·¯å¾‘è™•ç† --- */
function getMp3Path(val) {
    if (val === 'none') return "";
    const baseUrl = "https://johsok.github.io/Games/MP3/";
    return `${baseUrl}${val}.mp3`;
}

function unlockAudio() {
    userInteracted = true;
    if(audioCtx.state === 'suspended') audioCtx.resume();
    audio.volume = document.getElementById('bgm-vol').value/100;
    if (!audio.src || audio.src === "") {
        const val = document.getElementById('music-sel').value;
        if(val !== 'none') audio.src = getMp3Path(val);
    }
    if(document.getElementById('music-sel').value !== 'none') audio.play().catch(() => {});
}

document.addEventListener("visibilitychange", () => {
    if (document.hidden) { audio.pause(); } 
    else { if (userInteracted && document.getElementById('music-sel').value !== 'none') audio.play().catch(() => {}); }
});

document.addEventListener('click', unlockAudio, {once:true, capture:true}); 
document.addEventListener('touchstart', unlockAudio, {once:true, capture:true});

window.onload = () => {
    initImgList();
    resizeBoard(); 
    audio.src = getMp3Path(document.getElementById('music-sel').value);
    restart(); 
    window.addEventListener('resize', () => { setTimeout(resizeBoard, 100); });
};

function initImgList() {
    const sel = document.getElementById('img-sel');
    sel.innerHTML = "";
    // æ·»åŠ éš¨æ©Ÿé¸é …
    let optR = document.createElement('option');
    optR.value = "random";
    optR.text = TRANSLATIONS[currentLang].random;
    sel.appendChild(optR);

    // æ·»åŠ åˆ—è¡¨é¸é … (è‡ªå‹•ç§»é™¤ .jpg å¾Œç¶´é¡¯ç¤º)
    IMAGE_FILES.forEach(f => {
        let opt = document.createElement('option');
        opt.value = f; // å€¼ä¿ç•™å®Œæ•´æª”å
        // é¡¯ç¤ºæ–‡å­—ï¼šç§»é™¤æœ€å¾Œä¸€å€‹ . ä¹‹å¾Œçš„å­—å…ƒ
        let displayName = f.substring(0, f.lastIndexOf('.')) || f;
        opt.text = displayName;
        sel.appendChild(opt);
    });
}

function checkOrientation() { 
    const isLand = window.innerWidth > window.innerHeight && window.innerHeight < 650; 
    isLand ? document.body.classList.add('is-landscape') : document.body.classList.remove('is-landscape'); 
    return isLand; 
}

function resizeBoard() { 
    const isLand = checkOrientation(), wrap = document.getElementById('board-wrap'), header = document.getElementById('main-header');
    wrap.style.width = wrap.style.height = wrap.style.margin = ''; 
    header.style.marginRight = '0';
    const winW = window.innerWidth, winH = window.innerHeight; 
    let finalSize;
    if (isLand) {
        const headerW = 140, gap = winW * 0.02;
        header.style.marginRight = `${gap}px`;
        finalSize = Math.min(winW - headerW - gap - 20, winH - 20);
    } else {
        wrap.style.marginTop = '10px'; wrap.style.marginBottom = '10px';
        finalSize = Math.min(winW - 20, winH - header.offsetHeight - 20);
    }
    wrap.style.width = wrap.style.height = `${finalSize}px`;
    wrap.style.setProperty('--board-size', `${finalSize}px`);
    // é‡æ–°æ¸²æŸ“æ‹¼åœ–å¤§å°
    renderTiles();
}

function getImageUrl() {
    let val = document.getElementById('img-sel').value;
    if (val === 'random') {
        const randIdx = Math.floor(Math.random() * IMAGE_FILES.length);
        val = IMAGE_FILES[randIdx];
    }
    
    if(USE_PLACEHOLDER) {
        let seed = 0;
        for(let i=0; i<val.length; i++) seed += val.charCodeAt(i);
        return `https://picsum.photos/seed/${seed}/800/800`;
    }
    return `${IMG_PATH_PREFIX}${val}`;
}

// åœ–ç‰‡æç¤ºåŠŸèƒ½ - é¡¯ç¤º
function showHint() {
    toggleSet(); // é—œé–‰è¨­å®š UI
    const previewLayer = document.getElementById('preview-layer');
    const previewImg = document.getElementById('preview-img');
    const closeBtn = document.getElementById('hint-close-btn');
    
    previewImg.src = currentImgUrl;
    // ç§»é™¤å‹•ç•«ä¸¦ç›´æ¥é¡¯ç¤º
    previewImg.style.animation = 'none';
    previewImg.style.opacity = '1';
    previewImg.style.transform = 'scale(1)';
    
    // é¡¯ç¤ºé—œé–‰æŒ‰éˆ•
    closeBtn.style.display = 'block';
    
    previewLayer.classList.add('show');
    // å–æ¶ˆè‡ªå‹•é—œé–‰ setTimeoutï¼Œæ”¹ç‚ºå¸¸é§ç›´åˆ°ç”¨æˆ¶é»æ“Š X
}

// åœ–ç‰‡æç¤ºåŠŸèƒ½ - é—œé–‰
function closeHint() {
    const previewLayer = document.getElementById('preview-layer');
    const previewImg = document.getElementById('preview-img');
    const closeBtn = document.getElementById('hint-close-btn');

    previewLayer.classList.remove('show');
    closeBtn.style.display = 'none'; // éš±è—æŒ‰éˆ•
    
    // æ¢å¾©æ¨£å¼
    previewImg.style.opacity = '';
    previewImg.style.transform = '';
}

function restart() {
    isLocked = true;
    document.getElementById('win-overlay').classList.remove('show');
    gridSize = parseInt(document.getElementById('diff-sel').value);
    currentImgUrl = getImageUrl();
    historyStack = [];
    selectedIdx = -1;
    updateStatus(TRANSLATIONS[currentLang].msgMemo);

    // åˆå§‹åŒ–æ‹¼åœ–ç‹€æ…‹
    tiles = Array.from({length: gridSize * gridSize}, (_, i) => i);
    
    // æ´—ç‰Œ
    for (let i = tiles.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [tiles[i], tiles[j]] = [tiles[j], tiles[i]];
    }

    // æ¸²æŸ“æ‰“äº‚çš„èƒŒæ™¯
    renderTiles();

    // é¡¯ç¤ºé è¦½å±¤ 3 ç§’
    const previewLayer = document.getElementById('preview-layer');
    const previewImg = document.getElementById('preview-img');
    const closeBtn = document.getElementById('hint-close-btn');

    // ç¢ºä¿è¨˜æ†¶éšæ®µä¸é¡¯ç¤ºé—œé–‰æŒ‰éˆ•
    closeBtn.style.display = 'none';

    previewImg.src = currentImgUrl;
    previewLayer.classList.add('show');
    
    // é‡è¨­å‹•ç•«
    previewImg.style.animation = 'none';
    previewImg.offsetHeight; /* trigger reflow */
    previewImg.style.animation = 'memorize 3.5s ease-in-out forwards';

    setTimeout(() => {
        previewLayer.classList.remove('show');
        isLocked = false;
        updateStatus(TRANSLATIONS[currentLang].msgStart);
    }, 3500);
}

function renderTiles() {
    const container = document.getElementById('tiles-container');
    container.innerHTML = '';
    const tileSize = 100 / gridSize;
    
    tiles.forEach((originalIdx, currentPos) => {
        const el = document.createElement('div');
        el.className = 'tile';
        if (currentPos === selectedIdx) el.classList.add('selected');
        
        el.style.width = `${tileSize}%`;
        el.style.height = `${tileSize}%`;
        
        // è¨­å®šç›®å‰ä½ç½®
        const curX = currentPos % gridSize;
        const curY = Math.floor(currentPos / gridSize);
        el.style.left = `${curX * tileSize}%`;
        el.style.top = `${curY * tileSize}%`;
        
        // è¨­å®šèƒŒæ™¯åœ–ç‰‡é¡¯ç¤ºå€åŸŸ
        const orgX = originalIdx % gridSize;
        const orgY = Math.floor(originalIdx / gridSize);
        el.style.backgroundImage = `url('${currentImgUrl}')`;
        el.style.backgroundSize = `${gridSize * 100}%`;
        el.style.backgroundPosition = `${orgX * (100/(gridSize-1))}% ${orgY * (100/(gridSize-1))}%`;
        
        el.onclick = () => onTileClick(currentPos);
        container.appendChild(el);
    });
}

function onTileClick(idx) {
    if (isLocked) return;
    
    playSfx(400); 

    if (selectedIdx === -1) {
        selectedIdx = idx;
        renderTiles();
    } else if (selectedIdx === idx) {
        selectedIdx = -1;
        renderTiles();
    } else {
        historyStack.push([...tiles]);
        [tiles[selectedIdx], tiles[idx]] = [tiles[idx], tiles[selectedIdx]];
        selectedIdx = -1;
        playSfx(600);
        renderTiles();
        checkWin();
    }
}

function checkWin() {
    let isWin = true;
    for (let i = 0; i < tiles.length; i++) {
        if (tiles[i] !== i) {
            isWin = false;
            break;
        }
    }
    if (isWin) {
        isLocked = true;
        playSfx(800, 'win');
        const ol = document.getElementById('win-overlay');
        ol.innerText = TRANSLATIONS[currentLang].msgWin;
        ol.classList.add('show');
    }
}

function undo() {
    if (isLocked || historyStack.length === 0) return;
    tiles = historyStack.pop();
    selectedIdx = -1;
    renderTiles();
}

function updateStatus(txt) {
    document.getElementById('msg').innerText = txt;
}

function playSfx(freq, type) { 
    if(audioCtx.state === 'suspended') audioCtx.resume(); 
    const v = document.getElementById('sfx-vol').value/100; if(v <= 0.01) return; 
    const osc = audioCtx.createOscillator(), g = audioCtx.createGain(); 
    osc.connect(g); g.connect(audioCtx.destination); 
    if(type === 'win') {
        osc.type = "square"; osc.frequency.setValueAtTime(523.25, audioCtx.currentTime);
        g.gain.setValueAtTime(v, audioCtx.currentTime); g.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 1);
        osc.start(); osc.stop(audioCtx.currentTime+1);
    } else {
        osc.frequency.setValueAtTime(freq, audioCtx.currentTime);
        osc.frequency.exponentialRampToValueAtTime(freq/2, audioCtx.currentTime + 0.1);
        g.gain.setValueAtTime(v, audioCtx.currentTime); g.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + 0.15);
        osc.start(); osc.stop(audioCtx.currentTime+0.15);
    }
}

/* === è¨­å®šç›¸é—œå‡½æ•¸ === */
function toggleSet() { const s = document.getElementById('settings'); s.style.display = s.style.display==='block'?'none':'block'; }
function toggleRules() { const r = document.getElementById('rules-modal'); r.style.display = r.style.display==='flex'?'none':'flex'; }
function changeTheme() { document.body.className = document.getElementById('theme-sel').value; }
function changeDiff() { restart(); }
function changeImage() { restart(); }
function adjBgm() { audio.volume = document.getElementById('bgm-vol').value/100; document.getElementById('bgm-val-hint').innerText = document.getElementById('bgm-vol').value; }
function adjSfx() { document.getElementById('sfx-val-hint').innerText = document.getElementById('sfx-vol').value; } 

function changeMusic() {
    if(!userInteracted) unlockAudio();
    const val = document.getElementById('music-sel').value; 
    if(val === 'none') { audio.pause(); audio.src = ""; } 
    else { 
        const newPath = getMp3Path(val);
        if (audio.src !== newPath) {
            audio.src = newPath; audio.load();
            audio.play().catch(e => { console.log("Autoplay blocked", e); });
        }
    } 
}

function changeLang() {
    currentLang = document.getElementById('lang-sel').value; const t = TRANSLATIONS[currentLang];
    document.getElementById('app-title').innerText = t.title;
    document.getElementById('msg').innerText = isLocked ? t.msgMemo : t.msgStart;
    
    // æ›´æ–°é¸å–®æ–‡å­—
    document.getElementById('img-sel').options[0].text = t.random;
    document.getElementById('lbl-diff').innerText = t.diff;
    document.getElementById('lbl-img').innerText = t.img;
    document.getElementById('btn-undo').innerText = "â†©ï¸ " + t.undo;

    // æ›´æ–°è¨­å®šä»‹é¢
    document.getElementById('lbl-theme').innerText = t.theme;
    document.getElementById('lbl-music').innerText = t.music;
    document.getElementById('btn-settings').innerHTML = "âš™ï¸ " + t.settings;
    document.getElementById('btn-hint').innerHTML = "ğŸ‘ï¸ " + t.hint;
    document.getElementById('btn-done').innerText = t.done;
    document.getElementById('btn-rules').innerHTML = "ğŸ“– " + t.rules;
    document.getElementById('btn-home').innerHTML = "ğŸ  " + t.home;
    document.getElementById('rules-title').innerText = t.title;
    document.getElementById('btn-close-rules').innerText = t.closeRules;
    document.getElementById('lbl-vol-bgm').childNodes[0].nodeValue = t.volBgm;
    document.getElementById('lbl-vol-sfx').childNodes[0].nodeValue = t.volSfx;
}

function goHome() {
    try {
        if (window.parent && typeof window.parent.closeGame === 'function') { window.parent.closeGame(); } 
        else { console.log("No parent detected"); }
    } catch (e) { console.error("Error:", e); }
}

// é˜²è­·æ©Ÿåˆ¶
document.addEventListener('contextmenu', event => event.preventDefault());
document.onkeydown = function(e) {
    if (e.keyCode == 123) return false;
    if (e.ctrlKey && (e.keyCode == 'U'.charCodeAt(0) || e.keyCode == 'S'.charCodeAt(0))) return false;
};
console.log("%cæ‹¼åœ–ç³»çµ±å•Ÿå‹•", "color: orange; font-size: 20px; font-weight: bold;");
</script>
</body>
</html>